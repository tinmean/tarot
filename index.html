<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¡”ç¾…ç‰ŒæŠ½ç‰Œç¨‹å¼ï¼ˆç´”æ–‡å­—ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1 { margin-bottom: 12px; }

    .controls {
      margin: 14px 0 18px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    fieldset {
      border: 1px solid #ccc;
      padding: 8px 12px;
      border-radius: 10px;
      background: #fff;
    }

    legend {
      padding: 0 6px;
      color: #333;
      font-size: 14px;
    }

    button { padding: 10px 16px; font-size: 16px; cursor: pointer; }

    input[type="text"] {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 14px;
      width: 160px;
    }

    select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 14px;
    }

    .cards {
      display: grid;
      gap: 16px;
    }

    .spread-one { grid-template-columns: 1fr; justify-items: center; }
    .spread-three { grid-template-columns: repeat(3, 1fr); }
    .spread-five { grid-template-columns: repeat(5, 1fr); }
    .spread-twelve { grid-template-columns: repeat(4, 1fr); }

    /* åäºŒå¼µåœ“ç’°æ’åˆ—ï¼ˆè¦–è¦ºç”¨ï¼Œä¸å½±éŸ¿æ–‡å­—ï¼‰ */
    .spread-twelve.circle {
      position: relative;
      display: block;
      width: 760px;
      height: 760px;
      margin: 0 auto;
    }

    .spread-twelve.circle .card {
      position: absolute;
      width: 150px;
      transform: translate(-50%, -50%);
    }

    .spread-twelve.circle .card.center {
      left: 50% !important;
      top: 50% !important;
      width: 170px;
      z-index: 5;
    }

    /* äºŒæ“‡ä¸€ï¼šå·¦å³æ¯”è¼ƒå‹ç‰ˆé¢ï¼ˆåªåœ¨äº”å¼µç‰Œï¼‹äºŒæ“‡ä¸€æ™‚å•Ÿç”¨ï¼‰ */
    .spread-five.choice {
      grid-template-columns: repeat(3, 1fr);
      grid-template-areas:
        "a1 . b1"
        "a2 . b2"
        ". c .";
    }

    .spread-five.choice .c1 { grid-area: a1; }
    .spread-five.choice .c2 { grid-area: a2; }
    .spread-five.choice .c3 { grid-area: b1; }
    .spread-five.choice .c4 { grid-area: b2; }
    .spread-five.choice .c5 { grid-area: c; }

    .spread-celtic {
      grid-template-columns: repeat(6, minmax(0, 1fr));
      grid-template-rows: auto auto auto auto;
      grid-template-areas:
        ". . c5 . . c10"
        ". c4 c2 c6 . c9"
        ". . c1 . . c8"
        ". . c3 . . c7";
      align-items: start;
    }

    /* è³½çˆ¾ç‰¹åå­—å®šä½ */
    .spread-celtic .c1 { grid-area: c1; z-index: 1; }
    .spread-celtic .c2 { grid-area: c2; z-index: 2; transform: rotate(90deg); }
    .spread-celtic .c3 { grid-area: c3; }
    .spread-celtic .c4 { grid-area: c4; }
    .spread-celtic .c5 { grid-area: c5; }
    .spread-celtic .c6 { grid-area: c6; }
    .spread-celtic .c7 { grid-area: c7; }
    .spread-celtic .c8 { grid-area: c8; }
    .spread-celtic .c9 { grid-area: c9; }
    .spread-celtic .c10 { grid-area: c10; }

    /* è®“äº¤å‰ç‰Œæ›´åƒã€Œå£“åœ¨ã€ä¸­é–“ç‰Œä¸Š */
    .spread-celtic .c2 { margin-top: 18px; }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 22px 12px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .card:active {
      transform: translateY(1px);
    }

    .card-name {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .upright { color: #2b7a2b; }
    .reversed { color: #a12626; }

    .orientation {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .type {
      font-size: 16px;
      color: #555;
      margin-bottom: 10px;
    }

    .position-label {
      display: inline-block;
      margin-top: 6px;
      padding: 4px 10px;
      font-size: 14px;
      background: #f1f1f1;
      border-radius: 999px;
      color: #333;
    }

    textarea {
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      resize: vertical;
      background: #fff;
    }

    .subtle {
      font-size: 12px;
      color: #666;
      margin-top: -6px;
      margin-bottom: 12px;
    }

    /* ===== é»ç‰Œæ”¾å¤§ï¼ˆä¸è·³é ï¼‰ ===== */
    .card-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
    }

    .card-overlay.active {
      display: flex;
    }

    .overlay-card {
      width: min(92vw, 360px);
      max-height: 92vh;
      overflow: auto;
      background: #fff;
      border-radius: 18px;
      padding: 26px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      text-align: center;
    }

    .overlay-card .card-name { font-size: 30px; margin-bottom: 12px; }
    .overlay-card .orientation { font-size: 18px; margin-bottom: 8px; }
    .overlay-card .type { font-size: 16px; margin-bottom: 10px; }
    .overlay-card .position-label { font-size: 14px; }

    .overlay-hint {
      margin-top: 12px;
      font-size: 12px;
      color: #666;
    }

    /* ===== æ‰‹æ©Ÿç‰ˆæ’ç‰ˆå„ªåŒ–ï¼ˆç¶­æŒç‰Œé™£çµæ§‹ï¼Œç¸®å°æ–‡å­—ï¼‰ ===== */
    @media (max-width: 768px) {
      body { padding: 10px; }
      h1 { font-size: 18px; }
      .subtle { font-size: 11px; }
      .controls { gap: 6px; }

      input[type="text"], select, button { font-size: 14px; }
      fieldset { padding: 8px; }

      .card { padding: 14px 8px; }
      .card-name { font-size: 18px; margin-bottom: 8px; }
      .orientation { font-size: 13px; }
      .type { font-size: 12px; margin-bottom: 6px; }
      .position-label { font-size: 11px; padding: 3px 8px; }

      /* åäºŒå¼µåœ“ç›¤åœ¨æ‰‹æ©Ÿä¸Šæ•´é«”ç¸®æ”¾ï¼Œè€Œéæ”¹ç‰ˆå‹ */
      .spread-twelve.circle {
        transform: scale(0.85);
        transform-origin: top center;
      }

      textarea { font-size: 12px; }
    }
  </style>
</head>
<body>

<h1>ğŸ”® å¡”ç¾…ç‰ŒæŠ½ç‰Œç¨‹å¼ï¼ˆç´”æ–‡å­—ç‰ˆï¼‰</h1>
<div class="subtle">ç‰Œé™£åªæ±ºå®šã€ŒæŠ½å¹¾å¼µèˆ‡ä½ç½®ã€ï¼ŒæŠ½ç‰Œå…§å®¹è¨­å®šï¼ˆå¤§ç‰Œ/å°ç‰Œ/é€†ä½ï¼‰å¯ç¨ç«‹èª¿æ•´ã€‚é è¨­å…¨é¸ã€‚</div>

<div class="controls">
  <label>
    å•é¡Œç°¡è¿°ï¼ˆ10å­—å…§ï¼‰ï¼š
    <input id="question" type="text" maxlength="10" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œæ–¹å‘" />
  </label>

  <label>
    ç‰Œé™£ï¼š
    <select id="spread">
      <option value="one">å–®å¼µç‰Œ</option>
      <option value="three" selected>ä¸‰å¼µç‰Œ</option>
      <option value="five">äº”å¼µç‰Œ</option>
      <option value="twelve">åäºŒå¼µç‰Œ</option>
      <option value="celtic">è³½çˆ¾ç‰¹åå­—</option>
    </select>
  </label>

  <label id="threeVariantLabel">
    ä¸‰å¼µç‰Œé¡å‹ï¼š
    <select id="threeVariant">
      <option value="past_present_future" selected>éå»ï¼ç¾åœ¨ï¼æœªä¾†</option>
      <option value="situation_obstacle_advice">ç¾æ³ï¼å•é¡Œï¼å»ºè­°</option>
    </select>
  </label>

  <label id="fiveVariantLabel">
    äº”å¼µç‰Œé¡å‹ï¼š
    <select id="fiveVariant">
      <option value="wu_shi_lun" selected>ç„¡è¦–è«–ï¼ˆç„¡æç¤ºï¼‰</option>
      <option value="choice">äºŒæ“‡ä¸€ï¼ˆA vs Bï¼‰</option>
      <option value="horseshoe">é¦¬è¹„éµäº”å¼µï¼ˆéå»â†’çµæœï¼‰</option>
      <option value="challenge">ç¾æ³ï¼æŒ‘æˆ°ï¼æ½›åœ¨ï¼å»ºè­°ï¼çµæœ</option>
      <option value="blindspots">ç›²é»åˆ†æï¼ˆè¡¨è±¡ï¼äº‹å¯¦ï¼å¿½ç•¥ï¼èª¤åˆ¤ï¼é—œéµï¼‰</option>
    </select>
  </label>

  <label id="twelveVariantLabel">
    åäºŒå¼µç‰Œé¡å‹ï¼š
    <select id="twelveVariant">
      <option value="houses" selected>åäºŒå®®ä½</option>
      <option value="months">åäºŒå€‹æœˆ</option>
    </select>
  </label>

  <label id="twelveThemeLabel">
    <input type="checkbox" id="twelveTheme" checked /> åäºŒå¼µåœ“ç›¤åŠ å…¥ä¸»é¡Œç‰Œï¼ˆä¸­å¿ƒï¼‰
  </label>

  <fieldset>
    <legend>æŠ½ç‰Œå…§å®¹è¨­å®š</legend>
    <label style="margin-right:10px;">
      <input type="checkbox" id="useMajor" checked /> ä½¿ç”¨å¤§ç‰Œ
    </label>
    <label style="margin-right:10px;">
      <input type="checkbox" id="useMinor" checked /> ä½¿ç”¨å°ç‰Œ
    </label>
    <label>
      <input type="checkbox" id="allowReversed" checked /> åŒ…å«é€†ä½
    </label>
  </fieldset>

  <button id="drawBtn" type="button">æŠ½ç‰Œ</button>
</div>

<div id="result" class="cards"></div>

<!-- é»æ“Šæ”¾å¤§ç”¨é®ç½©ï¼ˆé»èƒŒæ™¯é—œé–‰ / ESC é—œé–‰ï¼‰ -->
<div id="cardOverlay" class="card-overlay" aria-hidden="true"></div>

<h2>ğŸ“œ æŠ½ç‰Œæ­·å²ç´€éŒ„ï¼ˆå¯è¤‡è£½ï¼‰</h2>
<div style="display:flex; gap:8px; margin-bottom:6px; flex-wrap: wrap;">
  <button id="copyHistoryBtn" type="button">è¤‡è£½å…¨éƒ¨</button>
  <button id="copyLastBtn" type="button">è¤‡è£½æœ€æ–°ä¸€ç­†</button>
  <button id="clearHistoryBtn" type="button">æ¸…é™¤ç´€éŒ„</button>
</div>
<textarea id="history" rows="6" style="width:100%;font-size:14px;" placeholder="å°šç„¡ç´€éŒ„" readonly></textarea>

<script>
  "use strict";

  // ===== ç‰Œåº« =====
  const majorArcana = [
    "æ„šè€…","é­”è¡“å¸«","å¥³ç¥­å¸","çš‡å","çš‡å¸","æ•™çš‡","æˆ€äºº","æˆ°è»Š","åŠ›é‡","éš±è€…",
    "å‘½é‹ä¹‹è¼ª","æ­£ç¾©","å€’åŠäºº","æ­»ç¥","ç¯€åˆ¶","æƒ¡é­”","é«˜å¡”","æ˜Ÿæ˜Ÿ","æœˆäº®","å¤ªé™½","å¯©åˆ¤","ä¸–ç•Œ"
  ];

  // å°é˜¿çˆ¾å…‹é‚£ï¼šå››èŠ±è‰² 1â€“10 + å®®å»·ç‰Œï¼ˆä¾è€…/é¨å£«/çš‡å/åœ‹ç‹ï¼‰= 56
  const minorArcana = (() => {
    const suits = ["æ¬Šæ–","è–æ¯","å¯¶åŠ","éŒ¢å¹£"];
    const courts = ["ä¾è€…","é¨å£«","çš‡å","åœ‹ç‹"];
    const out = [];

    for (const suit of suits) {
      for (let n = 1; n <= 10; n++) out.push({ name: suit + String(n), type: "å°é˜¿çˆ¾å…‹é‚£" });
      for (const court of courts) out.push({ name: suit + court, type: "å®®å»·ç‰Œ" });
    }

    return out;
  })();

  const THREE_CARD_VARIANTS = {
    past_present_future: ["éå»","ç¾åœ¨","æœªä¾†"],
    situation_obstacle_advice: ["ç¾æ³","å•é¡Œ","å»ºè­°"]
  };

  const FIVE_CARD_VARIANTS = {
    wu_shi_lun: [null, null, null, null, null],
    choice: ["é¸é …A","é¸é …Aèµ°å‘","é¸é …B","é¸é …Bèµ°å‘","å»ºè­°"],
    horseshoe: ["éå»","ç¾åœ¨","éšœç¤™","å»ºè­°","çµæœ"],
    challenge: ["ç¾æ³","æŒ‘æˆ°","æ½›åœ¨","å»ºè­°","çµæœ"],
    blindspots: ["è¡¨è±¡","äº‹å¯¦","å¿½ç•¥","èª¤åˆ¤","é—œéµ"]
  };

  const TWELVE_CARD_VARIANTS = {
    houses: [
      "ç¬¬ä¸€å®®ï¼šè‡ªæˆ‘","ç¬¬äºŒå®®ï¼šé‡‘éŒ¢","ç¬¬ä¸‰å®®ï¼šæºé€š","ç¬¬å››å®®ï¼šå®¶åº­",
      "ç¬¬äº”å®®ï¼šå‰µé€ ","ç¬¬å…­å®®ï¼šå·¥ä½œ","ç¬¬ä¸ƒå®®ï¼šé—œä¿‚","ç¬¬å…«å®®ï¼šè½‰åŒ–",
      "ç¬¬ä¹å®®ï¼šé æ™¯","ç¬¬åå®®ï¼šäº‹æ¥­","ç¬¬åä¸€å®®ï¼šäººéš›","ç¬¬åäºŒå®®ï¼šæ½›æ„è­˜"
    ],
    months: [
      "ä¸€æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ",
      "ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","åä¸€æœˆ","åäºŒæœˆ"
    ]
  };

  const CELTIC_POSITIONS = [
    "1 ç¾æ³",
    "2 é˜»ç¤™",
    "3 æ½›æ„è­˜",
    "4 éå»",
    "5 ç›®æ¨™",
    "6 æœªä¾†",
    "7 è‡ªæˆ‘",
    "8 ä»–äºº",
    "9 å¸Œæœ›èˆ‡ææ‡¼",
    "10 çµæœ"
  ];

  // ===== å°å·¥å…· =====
  const NEWLINE = "\n";

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = arr[i];
      arr[i] = arr[j];
      arr[j] = tmp;
    }
  }

  function degToRad(deg) {
    return deg * Math.PI / 180;
  }

  function getTimestamp() {
    const d = new Date();
    const pad = n => String(n).padStart(2, "0");
    return (
      d.getFullYear() + "-" +
      pad(d.getMonth() + 1) + "-" +
      pad(d.getDate()) + " " +
      pad(d.getHours()) + ":" +
      pad(d.getMinutes())
    );
  }

  // åäºŒå¼µåœ“ç›¤è§’åº¦ï¼š
  // - åäºŒå®®ä½ï¼šç¬¬ä¸€å®®åœ¨å·¦å´ï¼ˆ180Â°ï¼‰ï¼Œé€†æ™‚é‡æ’åˆ—
  // - åäºŒå€‹æœˆï¼šä¸€æœˆåœ¨ä¸Šæ–¹ï¼ˆ-90Â°ï¼‰ï¼Œé †æ™‚é‡æ’åˆ—
  function getTwelveAngle(variant, index0to11) {
    const step = 360 / 12;
    if (variant === "houses") {
      const base = 180;
      const dir = -1;
      return base + dir * step * index0to11;
    }
    // months
    const base = -90;
    const dir = 1;
    return base + dir * step * index0to11;
  }

  // ===== é»ç‰Œæ”¾å¤§ï¼ˆä¸è·³é ï¼‰ =====
  const overlay = document.getElementById("cardOverlay");

  function openOverlayFromData(cardDiv) {
    const cardName = cardDiv.dataset.cardName || "";
    const reversed = cardDiv.dataset.reversed === "1";
    const cardType = cardDiv.dataset.cardType || "";
    const position = cardDiv.dataset.position || "";

    overlay.innerHTML = "";

    const box = document.createElement("div");
    box.className = "overlay-card";

    const nameEl = document.createElement("div");
    nameEl.className = "card-name " + (reversed ? "reversed" : "upright");
    nameEl.textContent = cardName;

    const orientEl = document.createElement("div");
    orientEl.className = "orientation";
    orientEl.textContent = reversed ? "é€†ä½" : "æ­£ä½";

    const typeEl = document.createElement("div");
    typeEl.className = "type";
    typeEl.textContent = cardType;

    box.appendChild(nameEl);
    box.appendChild(orientEl);
    box.appendChild(typeEl);

    if (position) {
      const posEl = document.createElement("div");
      posEl.className = "position-label";
      posEl.textContent = position;
      box.appendChild(posEl);
    }

    const hint = document.createElement("div");
    hint.className = "overlay-hint";
    hint.textContent = "é»èƒŒæ™¯é—œé–‰ï¼ˆæˆ–æŒ‰ ESCï¼‰";
    box.appendChild(hint);

    overlay.appendChild(box);
    overlay.classList.add("active");
    overlay.setAttribute("aria-hidden", "false");
  }

  function closeOverlay() {
    overlay.classList.remove("active");
    overlay.setAttribute("aria-hidden", "true");
    overlay.innerHTML = "";
  }

  overlay.addEventListener("click", (e) => {
    // é»é®ç½©èƒŒæ™¯æ‰é—œé–‰ï¼ˆé»æ”¾å¤§å¡ç‰‡æœ¬èº«ä¸é—œé–‰ï¼‰
    if (e.target === overlay) closeOverlay();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlay.classList.contains("active")) {
      closeOverlay();
    }
  });

  // ===== ç”¢ç”Ÿå¡ç‰‡ DOM =====
  function renderCard(opts) {
    const cardName = opts.name;
    const reversed = !!opts.reversed;
    const cardType = opts.type;
    const position = opts.position;

    const div = document.createElement("div");
    div.className = "card";

    // å­˜è³‡æ–™çµ¦ overlay ä½¿ç”¨ï¼ˆé¿å… clone äº‹ä»¶/é¿å…å®£å‘Šè¡çªï¼‰
    div.dataset.cardName = cardName;
    div.dataset.reversed = reversed ? "1" : "0";
    div.dataset.cardType = cardType;
    div.dataset.position = position || "";

    div.addEventListener("click", () => openOverlayFromData(div));

    const nameEl = document.createElement("div");
    nameEl.className = "card-name " + (reversed ? "reversed" : "upright");
    nameEl.textContent = cardName;

    const orientation = document.createElement("div");
    orientation.className = "orientation";
    orientation.textContent = reversed ? "é€†ä½" : "æ­£ä½";

    const typeEl = document.createElement("div");
    typeEl.className = "type";
    typeEl.textContent = cardType;

    div.appendChild(nameEl);
    div.appendChild(orientation);
    div.appendChild(typeEl);

    if (position) {
      const pos = document.createElement("div");
      pos.className = "position-label";
      pos.textContent = position;
      div.appendChild(pos);
    }

    return div;
  }

  // ===== DOM =====
  const questionInput = document.getElementById("question");

  const spreadSelect = document.getElementById("spread");
  const threeVariantLabel = document.getElementById("threeVariantLabel");
  const fiveVariantLabel = document.getElementById("fiveVariantLabel");
  const twelveVariantLabel = document.getElementById("twelveVariantLabel");
  const twelveThemeLabel = document.getElementById("twelveThemeLabel");

  const threeVariant = document.getElementById("threeVariant");
  const fiveVariant = document.getElementById("fiveVariant");
  const twelveVariant = document.getElementById("twelveVariant");
  const twelveTheme = document.getElementById("twelveTheme");

  const useMajorCheckbox = document.getElementById("useMajor");
  const useMinorCheckbox = document.getElementById("useMinor");
  const allowReversedCheckbox = document.getElementById("allowReversed");

  const result = document.getElementById("result");

  const history = document.getElementById("history");
  const copyHistoryBtn = document.getElementById("copyHistoryBtn");
  const copyLastBtn = document.getElementById("copyLastBtn");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");

  // ===== è‡ªæˆ‘æ¸¬è©¦ï¼ˆä¿ç•™ + æ–°å¢ï¼‰ =====
  function assert(cond, msg) {
    if (!cond) throw new Error(msg);
  }

  function runSelfTests() {
    assert(majorArcana.length === 22, "å¤§é˜¿çˆ¾å…‹é‚£æ‡‰ç‚º 22 å¼µï¼Œå¯¦éš› " + majorArcana.length);

    Object.entries(THREE_CARD_VARIANTS).forEach(([k, v]) => {
      assert(Array.isArray(v) && v.length === 3, "ä¸‰å¼µç‰Œè®Šé«” " + k + " å¿…é ˆæ˜¯é•·åº¦ 3 çš„é™£åˆ—");
    });

    Object.entries(FIVE_CARD_VARIANTS).forEach(([k, v]) => {
      assert(Array.isArray(v) && v.length === 5, "äº”å¼µç‰Œè®Šé«” " + k + " å¿…é ˆæ˜¯é•·åº¦ 5 çš„é™£åˆ—");
    });

    Object.entries(TWELVE_CARD_VARIANTS).forEach(([k, v]) => {
      assert(Array.isArray(v) && v.length === 12, "åäºŒå¼µç‰Œè®Šé«” " + k + " å¿…é ˆæ˜¯é•·åº¦ 12 çš„é™£åˆ—");
    });

    assert(CELTIC_POSITIONS.length === 10, "è³½çˆ¾ç‰¹åå­—ä½ç½®æ‡‰ç‚º 10ï¼Œå¯¦éš› " + CELTIC_POSITIONS.length);

    assert(minorArcana.length === 56, "å°é˜¿çˆ¾å…‹é‚£æ‡‰ç‚º 56 å¼µï¼Œå¯¦éš› " + minorArcana.length);
    const minorNames = minorArcana.map(x => x.name);
    assert(new Set(minorNames).size === minorNames.length, "å°é˜¿çˆ¾å…‹é‚£ç‰Œåé‡è¤‡ï¼Œè«‹æª¢æŸ¥å»ºæ§‹ã€‚");

    assert(NEWLINE === "\n" && NEWLINE.length === 1, "NEWLINE å¿…é ˆæ˜¯ \\n å­—å…ƒ");

    for (let i = 0; i < 12; i++) {
      const a = getTwelveAngle("houses", i);
      const b = getTwelveAngle("months", i);
      assert(Number.isFinite(a) && Number.isFinite(b), "åäºŒå¼µè§’åº¦è¨ˆç®—çµæœå¿…é ˆç‚ºæœ‰é™æ•¸å­—");
    }

    const ts = getTimestamp();
    assert(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(ts), "æ™‚é–“æˆ³æ ¼å¼ä¸æ­£ç¢ºï¼š" + ts);

    // overlay åŸºæœ¬æª¢æŸ¥
    assert(overlay && typeof closeOverlay === "function", "overlay åˆå§‹åŒ–å¤±æ•—");
  }

  // ===== Cookie å·¥å…·ï¼ˆæ­·å²ç´€éŒ„ä¿å­˜ï¼‰ =====
  const HISTORY_COOKIE_KEY = "tarot_history_v1";
  const HISTORY_DAYS = 30;

  function setCookie(cookieName, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = cookieName + "=" + encodeURIComponent(value) + "; expires=" + expires + "; path=/";
  }

  function getCookie(cookieName) {
    const token = document.cookie
      .split("; ")
      .find(row => row.startsWith(cookieName + "="));

    return token ? token.split("=")[1] : undefined;
  }

  function loadHistoryFromCookie() {
    const raw = getCookie(HISTORY_COOKIE_KEY);
    if (!raw) return;

    try {
      const text = decodeURIComponent(raw);
      history.value = text;

      const lines = text.split(NEWLINE).filter(Boolean);
      if (lines.length) history.dataset.last = lines[lines.length - 1];
    } catch (e) {
      console.warn("è®€å–æ­·å² Cookie å¤±æ•—", e);
    }
  }

  function saveHistoryToCookie() {
    setCookie(HISTORY_COOKIE_KEY, history.value || "", HISTORY_DAYS);
  }

  // ===== UI è¡Œç‚º =====
  function updateVariantVisibility() {
    const spread = spreadSelect.value;
    threeVariantLabel.style.display = spread === "three" ? "inline-flex" : "none";
    fiveVariantLabel.style.display = spread === "five" ? "inline-flex" : "none";
    twelveVariantLabel.style.display = spread === "twelve" ? "inline-flex" : "none";
    twelveThemeLabel.style.display = spread === "twelve" ? "inline-flex" : "none";
  }

  function appendHistoryLine(line) {
    history.value = history.value ? history.value + NEWLINE + line : line;
    history.dataset.last = line;
    saveHistoryToCookie();
  }

  async function copyText(text) {
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
    } catch {
      history.focus();
      history.select();
      document.execCommand("copy");
    }
  }

  function buildDeck(useMajor, useMinor) {
    let deck = [];
    if (useMajor) deck = deck.concat(majorArcana.map(cardTitle => ({ name: cardTitle, type: "å¤§é˜¿çˆ¾å…‹é‚£" })));
    if (useMinor) deck = deck.concat(minorArcana);
    return deck;
  }

  function getSpreadLabel() {
    const spread = spreadSelect.value;
    if (spread === "one") return "å–®å¼µç‰Œ";
    if (spread === "three") return "ä¸‰å¼µç‰Œï¼" + threeVariant.options[threeVariant.selectedIndex].text;
    if (spread === "five") return "äº”å¼µç‰Œï¼" + fiveVariant.options[fiveVariant.selectedIndex].text;
    if (spread === "twelve") return "åäºŒå¼µç‰Œï¼" + twelveVariant.options[twelveVariant.selectedIndex].text;
    if (spread === "celtic") return "è³½çˆ¾ç‰¹åå­—";
    return "æœªçŸ¥ç‰Œé™£";
  }

  function drawCards() {
    const spread = spreadSelect.value;
    const allowReversed = allowReversedCheckbox.checked;
    const useMajor = useMajorCheckbox.checked;
    const useMinor = useMinorCheckbox.checked;

    if (!useMajor && !useMinor) {
      alert("è«‹è‡³å°‘é¸æ“‡ã€ä½¿ç”¨å¤§ç‰Œã€æˆ–ã€ä½¿ç”¨å°ç‰Œã€å…¶ä¸­ä¸€ç¨®ã€‚\nï¼ˆé è¨­å…¨é¸ï¼Œä½ å¯èƒ½ä¸å°å¿ƒéƒ½å–æ¶ˆäº†ï¼‰");
      return;
    }

    const questionText = (questionInput.value || "").trim();

    // åäºŒå¼µï¼šå¤–åœˆ 12 å¼µï¼›å¯é¸æ“‡åŠ ä¸€å¼µä¸­å¿ƒä¸»é¡Œç‰Œï¼ˆå…± 13 å¼µï¼‰
    const includeTwelveTheme = spread === "twelve" && twelveTheme.checked;
    const count =
      spread === "one" ? 1 :
      spread === "five" ? 5 :
      spread === "twelve" ? (includeTwelveTheme ? 13 : 12) :
      spread === "celtic" ? 10 :
      3;

    const deck = buildDeck(useMajor, useMinor);
    if (deck.length < count) {
      alert("ç‰Œåº«å¼µæ•¸ä¸è¶³ï¼ˆç›®å‰ " + deck.length + " å¼µï¼‰ï¼Œç„¡æ³•æŠ½å‡º " + count + " å¼µã€‚è«‹å‹¾é¸æ›´å¤šç‰Œæˆ–æ”¹ç”¨è¼ƒçŸ­ç‰Œé™£ã€‚");
      return;
    }

    shuffle(deck);

    // æ¸…ç©º + è¨­å®šç‰ˆé¢ class
    result.innerHTML = "";
    const isChoiceFive = spread === "five" && fiveVariant.value === "choice";

    if (spread === "twelve") {
      result.className = "cards spread-twelve circle";
    } else {
      result.className = "cards spread-" + spread + (isChoiceFive ? " choice" : "");
    }

    const historyNames = [];
    let deckIndex = 0;

    // åäºŒå¼µä¸­å¿ƒä¸»é¡Œç‰Œï¼ˆå¯é¸ï¼‰
    if (spread === "twelve" && includeTwelveTheme) {
      const reversed = allowReversed && Math.random() < 0.5;
      const cardText = reversed ? (deck[deckIndex].name + "(é€†)") : deck[deckIndex].name;
      historyNames.push("ä¸»é¡Œ:" + cardText);

      const themeEl = renderCard({
        name: deck[deckIndex].name,
        reversed,
        type: deck[deckIndex].type,
        position: "ä¸»é¡Œ"
      });
      themeEl.classList.add("center");
      result.appendChild(themeEl);
      deckIndex += 1;
    }

    const loopCount =
      spread === "twelve" ? 12 :
      spread === "celtic" ? 10 :
      spread === "five" ? 5 :
      spread === "one" ? 1 :
      3;

    for (let i = 0; i < loopCount; i++) {
      const reversed = allowReversed && Math.random() < 0.5;

      let position = null;
      if (spread === "three") position = THREE_CARD_VARIANTS[threeVariant.value][i];
      if (spread === "five") position = FIVE_CARD_VARIANTS[fiveVariant.value][i];
      if (spread === "twelve") position = TWELVE_CARD_VARIANTS[twelveVariant.value][i];
      if (spread === "celtic") position = CELTIC_POSITIONS[i];

      const cardText = reversed ? (deck[deckIndex].name + "(é€†)") : deck[deckIndex].name;
      historyNames.push(cardText);

      const cardEl = renderCard({
        name: deck[deckIndex].name,
        reversed,
        type: deck[deckIndex].type,
        position
      });

      if (spread === "five" && fiveVariant.value === "choice") {
        cardEl.classList.add("c" + String(i + 1));
      }

      if (spread === "celtic") {
        cardEl.classList.add("c" + String(i + 1));
      }

      if (spread === "twelve") {
        const angle = getTwelveAngle(twelveVariant.value, i);
        const radius = 300;
        const cx = 760 / 2;
        const cy = 760 / 2;
        const x = cx + radius * Math.cos(degToRad(angle));
        const y = cy + radius * Math.sin(degToRad(angle));
        cardEl.style.left = x + "px";
        cardEl.style.top = y + "px";
      }

      result.appendChild(cardEl);
      deckIndex += 1;
    }

    // å¯«å…¥æ­·å²ï¼šæ™‚é–“æˆ³ + å•é¡Œ(å¯é¸) + ç‰Œé™£ + æŠ½ç‰Œçµæœ
    const ts = getTimestamp();
    let line = "ã€" + ts + "ã€‘ ";
    if (questionText) line += "ã€" + questionText + "ã€‘ ";
    line += "ã€" + getSpreadLabel() + "ã€‘ " + historyNames.join(" ");
    appendHistoryLine(line);

    // æŠ½ç‰Œå®Œæˆå¾Œè‡ªå‹•æ¸…ç©ºå•é¡Œç°¡è¿°ï¼ˆé¿å…ä¸‹æ¬¡èª¤ç”¨ï¼‰
    questionInput.value = "";
  }

  // ===== ç¶å®šäº‹ä»¶ =====
  spreadSelect.addEventListener("change", updateVariantVisibility);
  document.getElementById("drawBtn").addEventListener("click", drawCards);

  copyHistoryBtn.addEventListener("click", () => copyText(history.value));
  copyLastBtn.addEventListener("click", () => copyText(history.dataset.last || ""));
  clearHistoryBtn.addEventListener("click", () => {
    history.value = "";
    delete history.dataset.last;
    saveHistoryToCookie();
  });

  // ===== åˆå§‹åŒ– =====
  try {
    runSelfTests();
  } catch (e) {
    console.error(e);
    alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
  }

  updateVariantVisibility();
  loadHistoryFromCookie();
</script>
</body>
</html>
