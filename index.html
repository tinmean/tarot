<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è€Kå¡”ç¾…ç‰ŒæŠ½ç‰Œç¨‹å¼ï¼ˆç´”æ–‡å­—ç‰ˆï¼‰</title>
  <style>
    :root {
      --bg-color: #f4f4f4;
      --card-bg: #fff;
      --primary-color: #333;
      --accent-color: #666;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-color);
      padding: 20px;
      margin: 0;
      color: var(--primary-color);
      /* ç§»é™¤ overflow-x: hidden ä»¥é¿å…åˆ‡åˆ°å…§å®¹ï¼Œè®“ä½¿ç”¨è€…å¿…è¦æ™‚å¯æ²å‹• */
    }

    h1 { margin-bottom: 12px; font-size: 1.5rem; }

    .controls {
      margin: 14px 0 18px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    fieldset {
      border: 1px solid #ccc;
      padding: 8px 12px;
      border-radius: 10px;
      background: #fff;
      margin: 0;
    }

    legend {
      padding: 0 6px;
      color: var(--primary-color);
      font-size: 14px;
      font-weight: bold;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 8px;
      transition: background 0.2s;
    }

    button:hover { background: #555; }
    button:active { transform: translateY(1px); }

    input[type="text"] {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 14px;
      width: 160px;
    }

    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 14px;
      max-width: 100%;
    }

    /* ===== ç‰Œé™£ Grid ç³»çµ± ===== */
    .cards {
      display: grid;
      gap: 16px;
      margin-top: 20px;
      width: 100%;
    }

    .spread-one { grid-template-columns: 1fr; justify-items: center; }
    .spread-three { grid-template-columns: repeat(3, 1fr); }
    .spread-five { grid-template-columns: repeat(5, 1fr); }
    
    /* åäºŒå¼µåœ“ç’°æ’åˆ—ï¼šåŸºç¤è¨­å®š */
    .spread-twelve.circle {
      position: relative;
      display: block;
      width: 760px; 
      height: 760px;
      margin: 0 auto;
      /* é è¨­ç¸®æ”¾ä¸­å¿ƒç‚ºé ‚éƒ¨ä¸­é–“ï¼Œæ–¹ä¾¿ RWD èª¿æ•´ */
      transform-origin: top center;
    }

    .spread-twelve.circle .card {
      position: absolute;
      width: 140px; /* ç¨å¾®ç¸®å°ä¸€é»é¿å…æ“æ“  */
      height: auto;
      transform: translate(-50%, -50%);
      margin: 0; /* ç§»é™¤ grid gap é€ æˆçš„å½±éŸ¿ */
    }

    .spread-twelve.circle .card.center {
      left: 50% !important;
      top: 50% !important;
      width: 160px;
      z-index: 5;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    /* äºŒæ“‡ä¸€ï¼šå·¦å³æ¯”è¼ƒå‹ç‰ˆé¢ */
    .spread-five.choice {
      grid-template-columns: repeat(3, 1fr);
      grid-template-areas:
        "a1 . b1"
        "a2 . b2"
        ". c .";
    }
    .spread-five.choice .c1 { grid-area: a1; }
    .spread-five.choice .c2 { grid-area: a2; }
    .spread-five.choice .c3 { grid-area: b1; }
    .spread-five.choice .c4 { grid-area: b2; }
    .spread-five.choice .c5 { grid-area: c; }

    /* è³½çˆ¾ç‰¹åå­— */
    .spread-celtic {
      grid-template-columns: repeat(6, 1fr);
      grid-template-areas:
        ". . c5 . . c10"
        ". c4 c2 c6 . c9"
        ". . c1 . . c8"
        ". . c3 . . c7";
      align-items: center;
      justify-items: center;
    }
    .spread-celtic .c1 { grid-area: c1; z-index: 1; }
    .spread-celtic .c2 { grid-area: c2; z-index: 2; transform: rotate(90deg); margin-top: 0; }
    .spread-celtic .c3 { grid-area: c3; }
    .spread-celtic .c4 { grid-area: c4; }
    .spread-celtic .c5 { grid-area: c5; }
    .spread-celtic .c6 { grid-area: c6; }
    .spread-celtic .c7 { grid-area: c7; }
    .spread-celtic .c8 { grid-area: c8; }
    .spread-celtic .c9 { grid-area: c9; }
    .spread-celtic .c10 { grid-area: c10; }

    /* ===== å¡ç‰‡æ¨£å¼ ===== */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px 10px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    
    .card:active { transform: translateY(1px); }

    .card-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .upright { color: #2b7a2b; border-bottom: 2px solid transparent; }
    .reversed { color: #a12626; border-bottom: 2px solid #a12626; padding-bottom: 2px; }

    .orientation { font-size: 14px; margin-bottom: 4px; color: #888; }
    .type { font-size: 12px; color: #aaa; margin-bottom: 8px; }

    .position-label {
      margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
      padding: 2px 8px;
      font-size: 12px;
      background: #eee;
      border-radius: 4px;
      color: #555;
    }

    textarea {
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      resize: vertical;
      background: #fff;
    }

    .subtle {
      font-size: 13px;
      color: var(--accent-color);
      margin-bottom: 12px;
    }

    /* ===== é»ç‰Œæ”¾å¤§ Overlay ===== */
    .card-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card-overlay.active { display: flex; opacity: 1; }

    .overlay-card {
      width: 100%;
      max-width: 320px;
      background: #fff;
      border-radius: 20px;
      padding: 30px 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      text-align: center;
      position: relative;
    }

    .overlay-card .card-name { font-size: 32px; margin-bottom: 16px; }
    .overlay-card .orientation { font-size: 20px; margin-bottom: 10px; }
    .overlay-card .type { font-size: 16px; margin-bottom: 20px; }
    .overlay-card .position-label { font-size: 16px; padding: 6px 12px; }

    .close-btn {
      margin-top: 20px;
      background: #eee;
      color: #333;
      width: 100%;
    }

    /* ===== æ‰‹æ©Ÿç‰ˆæ’ç‰ˆä¿®æ­£ ===== */
    @media (max-width: 768px) {
      /* èª¿æ•´å®¹å™¨ padding ä»¥çˆ­å–ç©ºé–“ */
      body { padding: 10px; }
      h1 { font-size: 1.25rem; }
      .controls { gap: 8px; }
      
      input[type="text"], select, button { font-size: 14px; width: 100%; }
      input[type="text"] { width: calc(100% - 22px); }

      /* å¡ç‰‡ç¸®å°é©æ‡‰æ‰‹æ©Ÿ Grid */
      .card { 
        padding: 8px 4px; 
        min-height: 90px; 
      }
      .card-name { 
        font-size: 14px; 
        margin-bottom: 4px; 
        white-space: nowrap; /* é¿å…æ›è¡Œå°è‡´ç‰ˆé¢éé•· */
        overflow: hidden; 
        text-overflow: ellipsis; 
      }
      .position-label { font-size: 10px; padding: 2px 4px; }
      .orientation { font-size: 11px; }
      .type { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—é¡åˆ¥ï¼Œä¿æŒç‰ˆé¢ç°¡æ½”ï¼Œé»é–‹æ‰çœ‹ */

      /* 1. å–®å¼µç‰Œ */
      .spread-one { grid-template-columns: 1fr; }

      /* 2. ä¸‰å¼µç‰Œï¼šæ‰‹æ©Ÿç‰ˆæ”¹å›æ©«å‘æ’åˆ— (3æ¬„) */
      .spread-three {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      /* 3. äº”å¼µç‰Œ (é€šç”¨/ç„¡è¦–è«–/é¦¬è¹„éµ/ç›²é»)ï¼šå¼·åˆ¶ 5æ¬„ä¸¦æ’ */
      /* èªªæ˜ï¼šç‚ºäº†è®“æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºäº”å¼µä¸¦æ’ï¼Œå­—é«”å¿…é ˆç¸®å°ä¸”ç§»é™¤éƒ¨åˆ†æè¿° */
      .spread-five:not(.choice) {
        grid-template-columns: repeat(5, 1fr);
        gap: 3px; /* æ¥µçª„é–“è· */
      }
      
      /* é‡å°äº”å¼µä¸¦æ’çš„æ¥µé™å£“ç¸®æ¨£å¼ */
      .spread-five:not(.choice) .card {
         padding: 6px 2px;
         min-height: 80px;
      }
      .spread-five:not(.choice) .card-name {
         font-size: 11px; /* ç¸®å°å­—é«” */
         margin-bottom: 2px;
         white-space: normal; /* å…è¨±æ›è¡Œ */
         line-height: 1.1;
      }
      /* éš±è— "æ­£ä½/é€†ä½" æ–‡å­—ï¼Œä¾é é¡è‰²è­˜åˆ¥ */
      .spread-five:not(.choice) .orientation {
         display: none; 
      }
      /* éš±è—æˆ–æ¥µç°¡åŒ–ä½ç½®æ¨™ç±¤ */
      .spread-five:not(.choice) .position-label {
         font-size: 9px;
         padding: 1px 2px;
         white-space: nowrap;
         overflow: hidden;
         text-overflow: ellipsis;
         max-width: 100%;
      }

      /* 4. äº”å¼µç‰Œ (äºŒæ“‡ä¸€)ï¼šæ¢å¾©ç‰¹æ®Šå½¢ç‹€ */
      .spread-five.choice {
        grid-template-columns: 1fr 0.4fr 1fr; /* å·¦å³å¯¬ï¼Œä¸­é–“çª„ */
        grid-template-areas:
          "a1 . b1"
          "a2 . b2"
          ". c .";
        gap: 8px;
      }
      /* ç¢ºä¿ Grid Area å°æ‡‰æ­£ç¢º */
      .spread-five.choice .c1 { grid-area: a1; margin: 0; }
      .spread-five.choice .c2 { grid-area: a2; margin: 0; }
      .spread-five.choice .c3 { grid-area: b1; margin: 0; }
      .spread-five.choice .c4 { grid-area: b2; margin: 0; }
      .spread-five.choice .c5 { grid-area: c; margin: 0; }

      /* 5. è³½çˆ¾ç‰¹åå­—ï¼šæ‰‹æ©Ÿç‰ˆç¶­æŒç›´åˆ— (éæ–¼è¤‡é›œç„¡æ³•å¡å…¥å°è¢å¹•) */
      .spread-celtic {
        grid-template-columns: 1fr;
        grid-template-areas: initial;
      }
      .spread-celtic .c1, .spread-celtic .c2, .spread-celtic .c3, 
      .spread-celtic .c4, .spread-celtic .c5, .spread-celtic .c6,
      .spread-celtic .c7, .spread-celtic .c8, .spread-celtic .c9, .spread-celtic .c10 {
        grid-area: auto;
        transform: none;
        margin: 0;
      }
      .spread-celtic::before {
        content: "ï¼ˆæ‰‹æ©Ÿç‰ˆå„ªåŒ–ç‚ºåˆ—è¡¨é¡¯ç¤ºï¼‰";
        display: block;
        color: #888;
        font-size: 12px;
        margin-bottom: 5px;
      }

      /* 6. åäºŒå¼µåœ“ç›¤ï¼šç¸®æ”¾é©æ‡‰ */
      .spread-twelve.circle {
        width: 760px;
        position: relative;
        left: 50%;
        margin-left: -380px;
        transform: scale(0.42); /* å†ç¸®å°ä¸€é»ç¢ºä¿ä¸åˆ‡é‚Š */
        transform-origin: top center;
        margin-bottom: -400px;
        margin-top: 20px;
      }
    }
  </style>
</head>
<body>

<h1>ğŸ”® è€Kå¡”ç¾…ç‰ŒæŠ½ç‰Œï¼ˆç´”æ–‡å­—ä¿®è¨‚ç‰ˆï¼‰</h1>
<div class="subtle"><a href="https://www.facebook.com/kfacehand" target="_blank" rel="noopener noreferrer">
    è¿½è¹¤è€Kæ‰‹é¢ç›¸ Facebook
</a></div>

<div class="subtle"><a href="https://tinmean.github.io/tarot/README.md" target="_blank" rel="noopener noreferrer">
    æŠ½ç‰Œç¨‹å¼èªªæ˜
</a></div>

<div class="controls">
  <label style="width:100%">
    å•é¡Œç°¡è¿°ï¼ˆé¸å¡«ï¼‰ï¼š
    <input id="question" type="text" maxlength="20" placeholder="ä¾‹å¦‚ï¼šé€™é€±å·¥ä½œé‹å‹¢..." />
  </label>

  <label>
    ç‰Œé™£ï¼š
    <select id="spread">
      <option value="one">å–®å¼µç‰Œ</option>
      <option value="three" >ä¸‰å¼µç‰Œ</option>
      <option value="five" selected>äº”å¼µç‰Œ</option>
      <option value="twelve">åäºŒå¼µç‰Œ</option>
      <option value="celtic">è³½çˆ¾ç‰¹åå­—</option>
    </select>
  </label>

  <label id="threeVariantLabel">
    é¡å‹ï¼š
    <select id="threeVariant">
      <option value="past_present_future" selected>éå»ï¼ç¾åœ¨ï¼æœªä¾†</option>
      <option value="situation_obstacle_advice">ç¾æ³ï¼å•é¡Œï¼å»ºè­°</option>
    </select>
  </label>

  <label id="fiveVariantLabel" style="display:none">
    é¡å‹ï¼š
    <select id="fiveVariant">
      <option value="wu_shi_lun" selected>ç„¡è¦–è«–ï¼ˆç„¡ä½ç½®å®šç¾©ï¼‰</option>
      <option value="choice">äºŒæ“‡ä¸€ï¼ˆA vs Bï¼‰</option>
      <option value="horseshoe">é¦¬è¹„éµï¼ˆéå»â†’çµæœï¼‰</option>
      <option value="blindspots">ç›²é»åˆ†æ</option>
    </select>
  </label>

  <label id="twelveVariantLabel" style="display:none">
    é¡å‹ï¼š
    <select id="twelveVariant">
      <option value="houses" selected>åäºŒå®®ä½</option>
      <option value="months">åäºŒå€‹æœˆ</option>
    </select>
  </label>

  <label id="twelveThemeLabel" style="display:none; align-items:center;">
    <input type="checkbox" id="twelveTheme" checked /> åŠ å…¥ä¸­å¿ƒä¸»é¡Œç‰Œ
  </label>

  <fieldset>
    <legend>è¨­å®š</legend>
    <label><input type="checkbox" id="useMajor" checked /> å¤§ç‰Œ</label>
    <label><input type="checkbox" id="useMinor" checked /> å°ç‰Œ</label>
    <label><input type="checkbox" id="allowReversed" checked /> é€†ä½</label>
  </fieldset>

  <button id="drawBtn" type="button">âœ¨ é–‹å§‹æŠ½ç‰Œ</button>
</div>

<div id="result" class="cards"></div>

<!-- Overlay -->
<div id="cardOverlay" class="card-overlay" aria-hidden="true">
  <div class="overlay-card" id="overlayContent">
    <!-- å…§å®¹å‹•æ…‹ç”Ÿæˆ -->
  </div>
</div>

<hr style="border:0; border-top:1px solid #ddd; margin: 30px 0;">

<h3>ğŸ“œ æ­·å²ç´€éŒ„</h3>
<div style="display:flex; gap:8px; margin-bottom:6px; flex-wrap: wrap;">
  <button id="copyHistoryBtn" type="button" style="background:#666; font-size:14px; padding:6px 12px;">è¤‡è£½å…¨éƒ¨</button>
  <button id="clearHistoryBtn" type="button" style="background:#999; font-size:14px; padding:6px 12px;">æ¸…é™¤ç´€éŒ„</button>
</div>
<textarea id="history" rows="6" style="width:100%; font-size:14px; line-height:1.5;" placeholder="æŠ½ç‰Œçµæœæœƒè‡ªå‹•é¡¯ç¤ºåœ¨æ­¤è™•..." readonly></textarea>

<script>
  "use strict";

  // ===== 1. è³‡æ–™åº«å®šç¾© =====
  const majorArcana = [
    "æ„šè€…","é­”è¡“å¸«","å¥³ç¥­å¸","çš‡å","çš‡å¸","æ•™çš‡","æˆ€äºº","æˆ°è»Š","åŠ›é‡","éš±è€…",
    "å‘½é‹ä¹‹è¼ª","æ­£ç¾©","å€’åŠäºº","æ­»ç¥","ç¯€åˆ¶","æƒ¡é­”","é«˜å¡”","æ˜Ÿæ˜Ÿ","æœˆäº®","å¤ªé™½","å¯©åˆ¤","ä¸–ç•Œ"
  ];

  const minorArcana = (() => {
    const suits = ["æ¬Šæ–","è–æ¯","å¯¶åŠ","éŒ¢å¹£"];
    const courts = ["ä¾è€…","é¨å£«","çš‡å","åœ‹ç‹"];
    const out = [];
    for (const suit of suits) {
      for (let n = 1; n <= 10; n++) out.push({ name: suit + (n===1?"Ace":n), type: "å°é˜¿çˆ¾å…‹é‚£" });
      for (const court of courts) out.push({ name: suit + court, type: "å®®å»·ç‰Œ" });
    }
    return out;
  })();

  const SPREAD_CONFIG = {
    three: {
      past_present_future: ["éå»","ç¾åœ¨","æœªä¾†"],
      situation_obstacle_advice: ["ç¾æ³","å•é¡Œ","å»ºè­°"]
    },
    five: {
      wu_shi_lun: [null, null, null, null, null],
      choice: ["é¸é …A","é¸é …Aèµ°å‘","é¸é …B","é¸é …Bèµ°å‘","å»ºè­°"],
      horseshoe: ["éå»","ç¾åœ¨","éšœç¤™","å»ºè­°","çµæœ"],
      blindspots: ["è¡¨è±¡","äº‹å¯¦","å¿½ç•¥","èª¤åˆ¤","é—œéµ"]
    },
    twelve: {
      houses: [
        "1å®®:è‡ªæˆ‘","2å®®:è²¡é‹","3å®®:æºé€š","4å®®:å®¶åº­","5å®®:æˆ€æ„›/å‰µé€ ","6å®®:å·¥ä½œ/å¥åº·",
        "7å®®:ä¼´ä¾¶/åˆä½œ","8å®®:åè²¡/ç”Ÿæ­»","9å®®:é è¡Œ/é€²ä¿®","10å®®:äº‹æ¥­/åæœ›","11å®®:äººéš›/ç¤¾ç¾¤","12å®®:æ½›æ„è­˜"
      ],
      months: ["ä¸€æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","åä¸€æœˆ","åäºŒæœˆ"]
    },
    celtic: [
      "1.ç¾æ³","2.é˜»ç¤™","3.æ½›æ„è­˜","4.éå»","5.ç›®æ¨™","6.æœªä¾†",
      "7.è‡ªæˆ‘","8.ç’°å¢ƒ","9.å¸Œæœ›/ææ‡¼","10.çµæœ"
    ]
  };

  // ===== 2. å·¥å…·å‡½å¼ =====
  
  // å„ªåŒ–ï¼šä½¿ç”¨ Crypto API é€²è¡Œæ›´éš¨æ©Ÿçš„æ´—ç‰Œ
  function secureShuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const randomBuffer = new Uint32Array(1);
      window.crypto.getRandomValues(randomBuffer);
      const j = randomBuffer[0] % (i + 1);
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function degToRad(deg) { return deg * Math.PI / 180; }

  function getTimestamp() {
    const d = new Date();
    const pad = n => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // åäºŒå¼µè§’åº¦è¨ˆç®—
  function getTwelveAngle(variant, index) {
    const step = 360 / 12;
    // 12å®®ä½ï¼šå¾å·¦(180åº¦)é–‹å§‹é€†æ™‚é‡
    if (variant === "houses") return 180 - (index * step);
    // 12æœˆä»½ï¼šå¾ä¸Š(-90åº¦)é–‹å§‹é †æ™‚é‡
    return -90 + (index * step);
  }

  // ===== 3. DOM èˆ‡ Overlay æ“ä½œ =====
  const overlay = document.getElementById("cardOverlay");
  const overlayContent = document.getElementById("overlayContent");

  function openOverlay(data) {
    overlayContent.innerHTML = `
      <div class="card-name ${data.reversed ? 'reversed' : 'upright'}">
        ${data.name} ${data.reversed ? '(é€†)' : ''}
      </div>
      <div class="orientation">${data.reversed ? 'é€†ä½ (Reversed)' : 'æ­£ä½ (Upright)'}</div>
      <div class="type">${data.type}</div>
      ${data.position ? `<div class="position-label">${data.position}</div>` : ''}
      <button class="close-btn" onclick="closeOverlay()">é—œé–‰</button>
    `;
    overlay.classList.add("active");
    overlay.setAttribute("aria-hidden", "false");
  }

  window.closeOverlay = function() {
    overlay.classList.remove("active");
    overlay.setAttribute("aria-hidden", "true");
  };

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) closeOverlay();
  });

  // ===== 4. æ ¸å¿ƒé‚è¼¯ =====
  function buildDeck(useMajor, useMinor) {
    let deck = [];
    if (useMajor) deck = deck.concat(majorArcana.map(n => ({ name: n, type: "å¤§é˜¿çˆ¾å…‹é‚£" })));
    if (useMinor) deck = deck.concat(minorArcana);
    return deck;
  }

  function renderCard(card, position, styleCallback) {
    const el = document.createElement("div");
    el.className = "card";
    
    // é»æ“Šäº‹ä»¶
    el.onclick = () => openOverlay({ ...card, position });

    el.innerHTML = `
      <div class="card-name ${card.reversed ? 'reversed' : 'upright'}">${card.name}</div>
      <div class="orientation">${card.reversed ? 'é€†ä½' : 'æ­£ä½'}</div>
      <div class="type">${card.type}</div>
      ${position ? `<div class="position-label">${position}</div>` : ''}
    `;

    if (styleCallback) styleCallback(el);
    return el;
  }

  function drawCards() {
    const spread = document.getElementById("spread").value;
    const useMajor = document.getElementById("useMajor").checked;
    const useMinor = document.getElementById("useMinor").checked;
    const allowReversed = document.getElementById("allowReversed").checked;
    const question = document.getElementById("question").value.trim();

    if (!useMajor && !useMinor) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ç‰Œçµ„ï¼ˆå¤§ç‰Œæˆ–å°ç‰Œï¼‰ï¼");

    // æº–å‚™ç‰Œåº«
    const deck = buildDeck(useMajor, useMinor);
    secureShuffle(deck);

    // è¨ˆç®—éœ€æ±‚å¼µæ•¸
    let positions = [];
    let isTwelve = false;
    let isCeltic = false;

    if (spread === "one") positions = [null];
    else if (spread === "three") positions = SPREAD_CONFIG.three[document.getElementById("threeVariant").value];
    else if (spread === "five") positions = SPREAD_CONFIG.five[document.getElementById("fiveVariant").value];
    else if (spread === "twelve") {
      positions = SPREAD_CONFIG.twelve[document.getElementById("twelveVariant").value];
      isTwelve = true;
    } else if (spread === "celtic") {
      positions = SPREAD_CONFIG.celtic;
      isCeltic = true;
    }

    // æª¢æŸ¥ä¸­å¿ƒä¸»é¡Œç‰Œ (åƒ…é™åäºŒå¼µ)
    const hasTheme = isTwelve && document.getElementById("twelveTheme").checked;
    const totalNeeded = positions.length + (hasTheme ? 1 : 0);

    if (deck.length < totalNeeded) return alert(`ç‰Œæ•¸ä¸è¶³ï¼ä½ éœ€è¦ ${totalNeeded} å¼µï¼Œä½†ç‰Œåº«åªæœ‰ ${deck.length} å¼µã€‚`);

    // é–‹å§‹ç¹ªè£½
    const container = document.getElementById("result");
    container.innerHTML = "";
    container.className = "cards spread-" + spread;
    if (spread === "five" && document.getElementById("fiveVariant").value === "choice") container.classList.add("choice");
    if (isTwelve) container.classList.add("circle");

    let cardIdx = 0;
    let resultText = [];

    // è™•ç†ä¸­å¿ƒä¸»é¡Œç‰Œ
    if (hasTheme) {
      const c = deck[cardIdx++];
      c.reversed = allowReversed && (window.crypto.getRandomValues(new Uint8Array(1))[0] < 128);
      resultText.push(`[ä¸»é¡Œ:${c.name}${c.reversed?'(é€†)':''}]`);
      
      const el = renderCard(c, "æ ¸å¿ƒä¸»é¡Œ");
      el.classList.add("center");
      container.appendChild(el);
    }

    // è™•ç†ä¸»è¦ä½ç½®
    positions.forEach((posName, i) => {
      const c = deck[cardIdx++];
      c.reversed = allowReversed && (window.crypto.getRandomValues(new Uint8Array(1))[0] < 128);
      
      resultText.push(`${posName || (i+1)}:${c.name}${c.reversed?'(é€†)':''}`);

      const el = renderCard(c, posName, (div) => {
        if (spread === "five" && document.getElementById("fiveVariant").value === "choice") div.classList.add("c"+(i+1));
        if (spread === "celtic") div.classList.add("c"+(i+1));
        
        // åäºŒå¼µåœ“å½¢è¨ˆç®—
        if (isTwelve) {
          const angle = getTwelveAngle(document.getElementById("twelveVariant").value, i);
          const r = 300; // åŠå¾‘
          const x = 380 + r * Math.cos(degToRad(angle)); // 380 æ˜¯ 760/2
          const y = 380 + r * Math.sin(degToRad(angle));
          div.style.left = x + "px";
          div.style.top = y + "px";
        }
      });
      container.appendChild(el);
    });

    // ç´€éŒ„
    const historyLine = `ã€${getTimestamp()}ã€‘${question ? `[å•:${question}] ` : ''}${resultText.join(" / ")}`;
    const historyArea = document.getElementById("history");
    historyArea.value = historyLine + "\n" + historyArea.value;
    
    // å­˜å…¥ Cookie
    document.cookie = "tarot_history=" + encodeURIComponent(historyArea.value) + "; max-age=" + (86400*30);
  }

  // ===== 5. UI äº‹ä»¶ç¶å®š =====
  function updateUI() {
    const val = document.getElementById("spread").value;
    document.getElementById("threeVariantLabel").style.display = val === "three" ? "inline-flex" : "none";
    document.getElementById("fiveVariantLabel").style.display = val === "five" ? "inline-flex" : "none";
    document.getElementById("twelveVariantLabel").style.display = val === "twelve" ? "inline-flex" : "none";
    document.getElementById("twelveThemeLabel").style.display = val === "twelve" ? "inline-flex" : "none";
  }

  document.getElementById("spread").addEventListener("change", updateUI);
  document.getElementById("drawBtn").addEventListener("click", drawCards);
  
  document.getElementById("copyHistoryBtn").addEventListener("click", () => {
    const h = document.getElementById("history");
    h.select();
    document.execCommand("copy"); // å…¼å®¹æ€§æœ€å¥½çš„è¤‡è£½æ–¹å¼
  });
  
  document.getElementById("clearHistoryBtn").addEventListener("click", () => {
    if(confirm("ç¢ºå®šæ¸…ç©ºç´€éŒ„ï¼Ÿ")) {
      document.getElementById("history").value = "";
      document.cookie = "tarot_history=; max-age=0";
    }
  });

  // è®€å–æ­·å²
  const match = document.cookie.match(/tarot_history=([^;]+)/);
  if (match) document.getElementById("history").value = decodeURIComponent(match[1]);

  updateUI();
</script>
</body>
</html>
