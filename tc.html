<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è€Kå¡”ç¾…ç‰ŒæŠ½ç‰Œç¨‹å¼ï¼ˆåœ–åƒç‰ˆï¼‰</title>
  <style>
    :root {
      --bg-color: #202020;
      --text-color: #e0e0e0;
      --card-bg: transparent;
      --accent-color: #aaa;
      --overlay-bg: rgba(0, 0, 0, 0.85);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-color);
      padding: 20px;
      margin: 0;
      color: var(--text-color);
    }

    h1 { margin-bottom: 12px; font-size: 1.5rem; text-align: center; color: #fff; }

    /* é€£çµæ¨£å¼ */
    a { color: #8ab4f8; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .subtle {
      font-size: 13px;
      color: var(--accent-color);
      margin-bottom: 12px;
      text-align: center;
    }

    /* æ§åˆ¶å€å¡Š */
    .controls {
      background: #333;
      padding: 15px;
      border-radius: 12px;
      margin: 14px auto 18px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      max-width: 800px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    fieldset {
      border: 1px solid #555;
      padding: 8px 12px;
      border-radius: 10px;
      background: #444;
      margin: 0;
    }

    legend {
      padding: 0 6px;
      color: #ddd;
      font-size: 14px;
      font-weight: bold;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #6a4c93;
      color: #fff;
      border: none;
      border-radius: 8px;
      transition: background 0.2s, transform 0.1s;
      font-weight: bold;
    }

    button:hover { background: #8260b0; }
    button:active { transform: translateY(1px); }

    input[type="text"], select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #222;
      color: #fff;
      font-size: 14px;
    }
    input[type="text"] { width: 180px; }

    /* ===== ç‰Œé™£ Grid ç³»çµ± ===== */
    .cards {
      display: grid;
      gap: 16px;
      margin: 30px auto;
      width: 100%;
      max-width: 1000px;
      justify-items: center;
    }

    .spread-one { grid-template-columns: 1fr; }
    .spread-three { grid-template-columns: repeat(3, 1fr); }
    .spread-five { grid-template-columns: repeat(5, 1fr); }
    
    /* åäºŒå¼µåœ“ç’°æ’åˆ— */
    .spread-twelve.circle {
      position: relative;
      display: block;
      width: 760px; 
      height: 760px;
      margin: 40px auto;
      transform-origin: top center;
    }

    .spread-twelve.circle .card-container {
      position: absolute;
      width: 100px;
      transform: translate(-50%, -50%);
    }

    .spread-twelve.circle .card-container.center {
      left: 50% !important;
      top: 50% !important;
      width: 120px;
      z-index: 10;
    }

    /* äºŒæ“‡ä¸€ï¼šå·¦å³æ¯”è¼ƒå‹ç‰ˆé¢ */
    .spread-five.choice {
      grid-template-columns: repeat(3, 1fr);
      grid-template-areas:
        "a1 . b1"
        "a2 . b2"
        ". c .";
    }
    .spread-five.choice .c1 { grid-area: a1; }
    .spread-five.choice .c2 { grid-area: a2; }
    .spread-five.choice .c3 { grid-area: b1; }
    .spread-five.choice .c4 { grid-area: b2; }
    .spread-five.choice .c5 { grid-area: c; }

    /* è³½çˆ¾ç‰¹åå­— */
    .spread-celtic {
      grid-template-columns: repeat(6, 1fr);
      grid-template-areas:
        ". . c5 . . c10"
        ". c4 c2 c6 . c9"
        ". . c1 . . c8"
        ". . c3 . . c7";
      align-items: center;
    }
    /* è³½çˆ¾ç‰¹åå­—ç‰¹æ®Šè™•ç† */
    .spread-celtic .c1 { grid-area: c1; z-index: 1; }
    .spread-celtic .c2 { 
        grid-area: c2; 
        z-index: 2; 
        /* è³½çˆ¾ç‰¹åå­—çš„ç¬¬äºŒå¼µé€šå¸¸æ˜¯æ©«æ”¾ï¼Œä½†åœ¨ç¶²é ä¸Šæ©«æ”¾åœ–æœƒå¾ˆé›£çœ‹æ¸…æ¥šï¼Œ
           é€™è£¡ä¿ç•™ç›´ç«‹ï¼Œä½†åœ¨UIä¸Šæ¨™ç¤ºç‚ºã€Œé˜»ç¤™ã€ */
        margin-top: 20px; 
        margin-left: 20px; 
    }
    .spread-celtic .c3 { grid-area: c3; }
    .spread-celtic .c4 { grid-area: c4; }
    .spread-celtic .c5 { grid-area: c5; }
    .spread-celtic .c6 { grid-area: c6; }
    .spread-celtic .c7 { grid-area: c7; }
    .spread-celtic .c8 { grid-area: c8; }
    .spread-celtic .c9 { grid-area: c9; }
    .spread-celtic .c10 { grid-area: c10; }

    /* ===== å¡ç‰‡æ¨£å¼ (å®¹å™¨) ===== */
    .card-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 150px; /* é›»è…¦ç‰ˆæœ€å¤§å¯¬åº¦ */
    }

    /* åœ–ç‰‡æœ¬é«” */
    .card-img-wrapper {
        position: relative;
        width: 100%;
        cursor: pointer;
        transition: transform 0.2s;
        /* å¢åŠ é™°å½±è®“ç‰Œæ›´æœ‰ç«‹é«”æ„Ÿ */
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
    }

    .card-img-wrapper:hover {
        transform: translateY(-5px);
        filter: drop-shadow(0 8px 12px rgba(0,0,0,0.6));
    }

    .card-img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
        transition: transform 0.5s ease-in-out;
    }

    /* é€†ä½æ¨£å¼ï¼šæ—‹è½‰180åº¦ */
    .card-img.reversed {
        transform: rotate(180deg);
    }

    /* å¡ç‰‡ä¸‹æ–¹çš„æ–‡å­—æ¨™ç±¤ */
    .card-info {
        margin-top: 8px;
        text-align: center;
    }

    .position-label {
        font-size: 12px;
        color: #aaa;
        background: #333;
        padding: 2px 6px;
        border-radius: 4px;
        margin-bottom: 2px;
        display: inline-block;
    }

    .card-name-text {
        font-size: 14px;
        font-weight: bold;
        color: #fff;
    }
    
    .card-status {
        font-size: 12px;
        color: #ff6b6b; /* é€†ä½é¡è‰² */
    }
    .card-status.up { color: #51cf66; /* æ­£ä½é¡è‰² */ }


    /* ===== æ­·å²ç´€éŒ„å€ ===== */
    textarea {
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #555;
      padding: 10px;
      background: #222;
      color: #ddd;
      width: 100%;
      resize: vertical;
    }

    /* ===== é»ç‰Œæ”¾å¤§ Overlay ===== */
    .card-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card-overlay.active { display: flex; opacity: 1; }

    .overlay-content {
      background: #2a2a2a;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      text-align: center;
      max-width: 400px;
      width: 100%;
      position: relative;
      border: 1px solid #444;
    }

    .overlay-img {
        max-width: 200px;
        height: auto;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .overlay-img.reversed { transform: rotate(180deg); }

    .overlay-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #fff; }
    .overlay-detail { font-size: 16px; color: #ccc; margin-bottom: 20px; }
    
    .close-btn {
      background: #444;
      color: #fff;
      width: 100%;
      margin-top: 10px;
    }
    .close-btn:hover { background: #555; }

    /* ===== æ‰‹æ©Ÿç‰ˆæ’ç‰ˆä¿®æ­£ ===== */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .controls { gap: 8px; padding: 10px; }
      input[type="text"], select, button { width: 100%; }
      input[type="text"] { width: calc(100% - 22px); }

      /* å¡ç‰‡å®¹å™¨ç¸®å° */
      .card-container { max-width: 100%; }
      
      /* æ–‡å­—ç¸®å° */
      .card-name-text { font-size: 12px; }
      .position-label { font-size: 10px; }

      /* 1. å–®å¼µç‰Œ */
      .spread-one { grid-template-columns: 1fr; max-width: 200px; }

      /* 2. ä¸‰å¼µç‰Œï¼šä¿æŒä¸‰æ¬„ï¼Œä½†é–“è·ç¸®å° */
      .spread-three { gap: 8px; }

      /* 3. äº”å¼µç‰Œ (ä¸€èˆ¬)ï¼šæ‰‹æ©Ÿç‰ˆå¼·åˆ¶ 5æ¬„ä¸¦æ’ï¼Œå­—é«”æ¥µå°åŒ– */
      .spread-five:not(.choice) {
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
      }
      .spread-five:not(.choice) .card-container {
         /* äº”å¼µä¸¦æ’æ™‚ï¼Œåœ–æœƒè®Šå¾ˆå° */
      }
      .spread-five:not(.choice) .position-label { display: none; } /* ç©ºé–“ä¸è¶³éš±è—ä½ç½® */

      /* 4. äº”å¼µç‰Œ (äºŒæ“‡ä¸€) */
      .spread-five.choice {
        gap: 6px;
        grid-template-columns: 1fr 0.2fr 1fr;
      }

      /* 5. è³½çˆ¾ç‰¹åå­—ï¼šæ‰‹æ©Ÿç‰ˆæ”¹ç‚ºç›´åˆ—é¡¯ç¤º */
      .spread-celtic {
        grid-template-columns: repeat(3, 1fr); /* æ”¹ç‚º3æ¬„ç¶²æ ¼æ¯”è¼ƒå¥½é–±è®€ */
        grid-template-areas: initial;
        gap: 10px;
      }
      .spread-celtic .card-container { margin: 0; }
      .spread-celtic .c1, .spread-celtic .c2, .spread-celtic .c3, 
      .spread-celtic .c4, .spread-celtic .c5, .spread-celtic .c6,
      .spread-celtic .c7, .spread-celtic .c8, .spread-celtic .c9, .spread-celtic .c10 {
        grid-area: auto; transform: none; margin: 0;
      }
      .spread-celtic::before {
        content: "ï¼ˆæ‰‹æ©Ÿç‰ˆå„ªåŒ–ç‚ºç¶²æ ¼é¡¯ç¤ºï¼‰";
        display: block;
        width: 100%;
        grid-column: 1 / -1;
        text-align: center;
        color: #888;
        font-size: 12px;
        margin-bottom: 5px;
      }

      /* 6. åäºŒå¼µåœ“ç›¤ï¼šç¸®æ”¾ */
      .spread-twelve.circle {
        width: 760px;
        left: 50%;
        margin-left: -380px;
        transform: scale(0.42); /* ç¸®å°ä»¥é©æ‡‰æ‰‹æ©Ÿè¢å¹•å¯¬åº¦ */
        margin-top: 10px;
        margin-bottom: -420px;
      }
    }
  </style>
</head>
<body>

<h1>ğŸ”® è€Kå¡”ç¾…ç‰Œï¼ˆåœ–åƒç‰ˆï¼‰</h1>
<div class="subtle">
    <a href="https://kfacehand.com" target="_blank">è€Kæ‰‹é¢ç›¸å®˜ç¶²</a> | 
    <a href="https://www.facebook.com/kfacehand" target="_blank">è€Kæ‰‹é¢ç›¸ Facebook</a>
</div>

<div class="controls">
  <label style="width:100%">
    å•é¡Œç°¡è¿°ï¼š
    <input id="question" type="text" maxlength="20" placeholder="å¿ƒè£¡é»˜å¿µå•é¡Œ..." />
  </label>

  <label style="flex-grow: 1;">
    ç‰Œé™£ï¼š
    <select id="spread">
      <option value="one">å–®å¼µç‰Œ (æ¯æ—¥é‹å‹¢)</option>
      <option value="three" >ä¸‰å¼µç‰Œ (æ™‚é–“æµ)</option>
      <option value="five" selected>äº”å¼µç‰Œ (å¤šæ¨¡å¼)</option>
      <option value="twelve">åäºŒå¼µç‰Œ (æµå¹´/å®®ä½)</option>
      <option value="celtic">è³½çˆ¾ç‰¹åå­— (æ·±åº¦åˆ†æ)</option>
    </select>
  </label>

  <!-- è®Šé«”é¸æ“‡å€ (å‹•æ…‹é¡¯ç¤º) -->
  <label id="threeVariantLabel">
    é¡å‹ï¼š
    <select id="threeVariant">
      <option value="past_present_future" selected>éå» / ç¾åœ¨ / æœªä¾†</option>
      <option value="situation_obstacle_advice">ç¾æ³ / å•é¡Œ / å»ºè­°</option>
    </select>
  </label>

  <label id="fiveVariantLabel" style="display:none">
    é¡å‹ï¼š
    <select id="fiveVariant">
      <option value="wu_shi_lun" selected>ç„¡è¦–è«– (è‡ªç”±è§£è®€)</option>
      <option value="choice">äºŒæ“‡ä¸€ (A vs B)</option>
      <option value="horseshoe">é¦¬è¹„éµ (ç™¼å±•è¶¨å‹¢)</option>
      <option value="blindspots">ç›²é»åˆ†æ</option>
    </select>
  </label>

  <label id="twelveVariantLabel" style="display:none">
    é¡å‹ï¼š
    <select id="twelveVariant">
      <option value="houses" selected>åäºŒå®®ä½ (ç”Ÿæ´»é ˜åŸŸ)</option>
      <option value="months">åäºŒå€‹æœˆ (æµå¹´é‹å‹¢)</option>
    </select>
  </label>

  <label id="twelveThemeLabel" style="display:none; align-items:center; color:#ddd;">
    <input type="checkbox" id="twelveTheme" checked /> ä¸­å¿ƒä¸»é¡Œç‰Œ
  </label>

  <fieldset>
    <legend>è¨­å®š</legend>
    <label><input type="checkbox" id="useMajor" checked /> å¤§ç‰Œ</label>
    <label><input type="checkbox" id="useMinor" checked /> å°ç‰Œ</label>
    <label><input type="checkbox" id="allowReversed" checked /> å…è¨±é€†ä½</label>
  </fieldset>

  <button id="drawBtn" type="button">âœ¨ æŠ½ç‰Œ</button>
</div>

<!-- æŠ½ç‰Œçµæœå€ -->
<div id="result" class="cards"></div>

<!-- æ”¾å¤§æª¢è¦– (Overlay) -->
<div id="cardOverlay" class="card-overlay" aria-hidden="true">
  <div class="overlay-content" id="overlayContent">
    <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
  </div>
</div>

<hr style="border:0; border-top:1px solid #444; margin: 30px 0;">

<h3>ğŸ“œ æ­·å²ç´€éŒ„</h3>
<div style="display:flex; gap:8px; margin-bottom:6px; flex-wrap: wrap;">
  <button id="copyLatestBtn" type="button" style="background:#444; font-size:14px; padding:6px 12px;">è¤‡è£½æœ€æ–°</button>
  <button id="copyHistoryBtn" type="button" style="background:#666; font-size:14px; padding:6px 12px;">è¤‡è£½å…¨éƒ¨</button>
  <button id="clearHistoryBtn" type="button" style="background:#999; font-size:14px; padding:6px 12px;">æ¸…é™¤ç´€éŒ„</button>
</div>
<textarea id="history" rows="6" placeholder="æŠ½ç‰Œçµæœæœƒè‡ªå‹•å„²å­˜æ–¼æ­¤..." readonly></textarea>

<script>
  "use strict";

  // ===== è¨­å®šï¼šåœ–ç‰‡è·¯å¾‘ =====
  // å‡è¨­ HTML èˆ‡ images è³‡æ–™å¤¾åœ¨åŒä¸€å±¤ç´š
  // å¦‚æœæ˜¯ GitHub Pagesï¼Œè·¯å¾‘é€šå¸¸æ˜¯ ./images/
  const IMG_BASE_PATH = "./images/"; 

  // ===== 1. è³‡æ–™åº«å®šç¾© =====
  
  // å¤§é˜¿çˆ¾å…‹é‚£ï¼šå°æ‡‰ maj00.jpg ~ maj21.jpg
  const majorArcana = [
    {name: "0. æ„šè€…", file: "maj00.jpg"},
    {name: "I. é­”è¡“å¸«", file: "maj01.jpg"},
    {name: "II. å¥³ç¥­å¸", file: "maj02.jpg"},
    {name: "III. çš‡å", file: "maj03.jpg"},
    {name: "IV. çš‡å¸", file: "maj04.jpg"},
    {name: "V. æ•™çš‡", file: "maj05.jpg"},
    {name: "VI. æˆ€äºº", file: "maj06.jpg"},
    {name: "VII. æˆ°è»Š", file: "maj07.jpg"},
    {name: "VIII. åŠ›é‡", file: "maj08.jpg"},
    {name: "IX. éš±è€…", file: "maj09.jpg"},
    {name: "X. å‘½é‹ä¹‹è¼ª", file: "maj10.jpg"},
    {name: "XI. æ­£ç¾©", file: "maj11.jpg"},
    {name: "XII. å€’åŠäºº", file: "maj12.jpg"},
    {name: "XIII. æ­»ç¥", file: "maj13.jpg"},
    {name: "XIV. ç¯€åˆ¶", file: "maj14.jpg"},
    {name: "XV. æƒ¡é­”", file: "maj15.jpg"},
    {name: "XVI. é«˜å¡”", file: "maj16.jpg"},
    {name: "XVII. æ˜Ÿæ˜Ÿ", file: "maj17.jpg"},
    {name: "XVIII. æœˆäº®", file: "maj18.jpg"},
    {name: "XIX. å¤ªé™½", file: "maj19.jpg"},
    {name: "XX. å¯©åˆ¤", file: "maj20.jpg"},
    {name: "XXI. ä¸–ç•Œ", file: "maj21.jpg"}
  ];

  // å°é˜¿çˆ¾å…‹é‚£ç”¢ç”Ÿå™¨ï¼šå°æ‡‰ suit01.jpg ~ suit14.jpg
  const minorArcana = (() => {
    // æ ¹æ“šä½ æä¾›çš„æª”åè¦å‰‡ï¼š
    // æ¬Šæ–=wands, è–æ¯=cups, å¯¶åŠ=swords, éŒ¢å¹£=pents
    const suits = [
      { name: "æ¬Šæ–", code: "wands" },
      { name: "è–æ¯", code: "cups" },
      { name: "å¯¶åŠ", code: "swords" },
      { name: "éŒ¢å¹£", code: "pents" }
    ];
    // 1-10, 11=ä¾è€…(Page), 12=é¨å£«(Knight), 13=çš‡å(Queen), 14=åœ‹ç‹(King)
    const ranks = ["Ace", "2", "3", "4", "5", "6", "7", "8", "9", "10", "ä¾è€…", "é¨å£«", "çš‡å", "åœ‹ç‹"];
    
    const out = [];
    for (const suit of suits) {
      ranks.forEach((rank, index) => {
        // æª”åè£œé›¶ï¼š01, 02... 14
        const numStr = String(index + 1).padStart(2, '0');
        const fileName = `${suit.code}${numStr}.jpg`;
        const type = (index + 1) > 10 ? "å®®å»·ç‰Œ" : "å°é˜¿çˆ¾å…‹é‚£";
        
        out.push({
          name: `${suit.name} ${rank}`,
          file: fileName,
          type: type
        });
      });
    }
    return out;
  })();

  const SPREAD_CONFIG = {
    three: {
      past_present_future: ["éå»","ç¾åœ¨","æœªä¾†"],
      situation_obstacle_advice: ["ç¾æ³","å•é¡Œ","å»ºè­°"]
    },
    five: {
      wu_shi_lun: ["1", "2", "3", "4", "5"],
      choice: ["é¸é …A","Aèµ°å‘","é¸é …B","Bèµ°å‘","æ ¸å¿ƒå»ºè­°"],
      horseshoe: ["éå»","ç¾åœ¨","éšœç¤™","å»ºè­°","çµæœ"],
      blindspots: ["è¡¨è±¡","äº‹å¯¦","å¿½ç•¥","èª¤åˆ¤","é—œéµ"]
    },
    twelve: {
      houses: [
        "1å®®(è‡ªæˆ‘)","2å®®(è²¡é‹)","3å®®(æºé€š)","4å®®(å®¶åº­)","5å®®(ç©æ¨‚)","6å®®(å·¥ä½œ)",
        "7å®®(ä¼´ä¾¶)","8å®®(åè²¡)","9å®®(é è¡Œ)","10å®®(äº‹æ¥­)","11å®®(ç¤¾ç¾¤)","12å®®(éš±å¯†)"
      ],
      months: ["ä¸€æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","åä¸€æœˆ","åäºŒæœˆ"]
    },
    celtic: [
      "1.ç¾æ³","2.é˜»ç¤™","3.æ½›æ„è­˜","4.éå»","5.ç›®æ¨™","6.æœªä¾†",
      "7.è‡ªæˆ‘","8.ç’°å¢ƒ","9.å¸Œæœ›/ææ‡¼","10.çµæœ"
    ]
  };

  // ===== 2. å·¥å…·å‡½å¼ =====
  
  // æ›´åŠ éš¨æ©Ÿçš„æ´—ç‰Œ (Fisher-Yates with Crypto API)
  function secureShuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const randomBuffer = new Uint32Array(1);
      window.crypto.getRandomValues(randomBuffer);
      const j = randomBuffer[0] % (i + 1);
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function degToRad(deg) { return deg * Math.PI / 180; }

  function getTimestamp() {
    const d = new Date();
    const pad = n => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // åäºŒå¼µè§’åº¦è¨ˆç®—
  function getTwelveAngle(variant, index) {
    const step = 360 / 12;
    if (variant === "houses") return 180 - (index * step); // 1å®®åœ¨å·¦(9é»é˜æ–¹å‘)ï¼Œé€†æ™‚é‡
    return -90 + (index * step); // 1æœˆåœ¨ä¸Š(12é»é˜æ–¹å‘)ï¼Œé †æ™‚é‡
  }

  // ===== 3. DOM èˆ‡ Overlay æ“ä½œ =====
  const overlay = document.getElementById("cardOverlay");
  const overlayContent = document.getElementById("overlayContent");

  function openOverlay(data) {
    const imgPath = IMG_BASE_PATH + data.file;
    const statusText = data.reversed ? "é€†ä½ (Reversed)" : "æ­£ä½ (Upright)";
    const statusClass = data.reversed ? "" : "up"; // ç´…è‰²æˆ–ç¶ è‰²æ–‡å­—

    overlayContent.innerHTML = `
      <h3 class="overlay-title">${data.name}</h3>
      <img src="${imgPath}" class="overlay-img ${data.reversed ? 'reversed' : ''}" alt="${data.name}" />
      <div class="overlay-detail">
        <div class="card-status ${statusClass}">${statusText}</div>
        <div style="margin-top:5px; color:#888;">${data.position ? `ä½ç½®ï¼š${data.position}` : ''}</div>
        <div style="font-size:14px; margin-top:5px; opacity:0.7;">${data.type || ''}</div>
      </div>
      <button class="close-btn" onclick="closeOverlay()">é—œé–‰</button>
    `;
    overlay.classList.add("active");
    overlay.setAttribute("aria-hidden", "false");
  }

  window.closeOverlay = function() {
    overlay.classList.remove("active");
    overlay.setAttribute("aria-hidden", "true");
  };

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) closeOverlay();
  });

  // ===== 4. æ ¸å¿ƒé‚è¼¯ (æ¸²æŸ“å¡ç‰‡) =====
  
  function buildDeck(useMajor, useMinor) {
    let deck = [];
    if (useMajor) deck = deck.concat(majorArcana.map(c => ({...c, type: "å¤§é˜¿çˆ¾å…‹é‚£"})));
    if (useMinor) deck = deck.concat(minorArcana);
    return deck;
  }

  // æ¸²æŸ“å–®å¼µå¡ç‰‡ DOM
  function renderCard(card, position, styleCallback) {
    const container = document.createElement("div");
    container.className = "card-container";

    // é»æ“Šæ”¾å¤§
    container.onclick = () => openOverlay({ ...card, position });

    const imgPath = IMG_BASE_PATH + card.file;
    const reversedClass = card.reversed ? "reversed" : "";
    const statusSymbol = card.reversed ? "(é€†)" : "";
    const statusColorClass = card.reversed ? "" : "up";

    container.innerHTML = `
      <div class="card-img-wrapper">
         <img src="${imgPath}" class="card-img ${reversedClass}" alt="${card.name}" onerror="this.onerror=null;this.src='https://placehold.co/150x250?text=Image+Not+Found';">
      </div>
      <div class="card-info">
         ${position ? `<div class="position-label">${position}</div>` : ''}
         <div class="card-name-text">
            ${card.name} 
            <span class="card-status ${statusColorClass}">${statusSymbol}</span>
         </div>
      </div>
    `;

    if (styleCallback) styleCallback(container);
    return container;
  }

  function drawCards() {
    const spread = document.getElementById("spread").value;
    const useMajor = document.getElementById("useMajor").checked;
    const useMinor = document.getElementById("useMinor").checked;
    const allowReversed = document.getElementById("allowReversed").checked;
    const question = document.getElementById("question").value.trim();

    if (!useMajor && !useMinor) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ç‰Œçµ„ï¼ˆå¤§ç‰Œæˆ–å°ç‰Œï¼‰ï¼");

    // æº–å‚™ç‰Œåº«
    const deck = buildDeck(useMajor, useMinor);
    secureShuffle(deck);

    // è¨ˆç®—ä½ç½®
    let positions = [];
    let isTwelve = false;

    if (spread === "one") positions = [null];
    else if (spread === "three") positions = SPREAD_CONFIG.three[document.getElementById("threeVariant").value];
    else if (spread === "five") positions = SPREAD_CONFIG.five[document.getElementById("fiveVariant").value];
    else if (spread === "twelve") {
      positions = SPREAD_CONFIG.twelve[document.getElementById("twelveVariant").value];
      isTwelve = true;
    } else if (spread === "celtic") {
      positions = SPREAD_CONFIG.celtic;
    }

    // æª¢æŸ¥ä¸­å¿ƒä¸»é¡Œç‰Œ (åƒ…é™åäºŒå¼µ)
    const hasTheme = isTwelve && document.getElementById("twelveTheme").checked;
    const totalNeeded = positions.length + (hasTheme ? 1 : 0);

    if (deck.length < totalNeeded) return alert(`ç‰Œæ•¸ä¸è¶³ï¼ä½ éœ€è¦ ${totalNeeded} å¼µï¼Œä½†ç‰Œåº«åªæœ‰ ${deck.length} å¼µã€‚`);

    // é–‹å§‹ç¹ªè£½
    const container = document.getElementById("result");
    container.innerHTML = "";
    container.className = "cards spread-" + spread;
    
    // åŠ ä¸Šç‰¹æ®Š class
    if (spread === "five" && document.getElementById("fiveVariant").value === "choice") container.classList.add("choice");
    if (isTwelve) container.classList.add("circle");

    let cardIdx = 0;
    let resultText = [];

    // A. è™•ç†ä¸­å¿ƒä¸»é¡Œç‰Œ (åäºŒå¼µç‰Œé™£ç”¨)
    if (hasTheme) {
      const c = deck[cardIdx++];
      c.reversed = allowReversed && (window.crypto.getRandomValues(new Uint8Array(1))[0] < 128);
      resultText.push(`[ä¸»é¡Œ:${c.name}${c.reversed?'(é€†)':''}]`);
      
      const el = renderCard(c, "æ ¸å¿ƒä¸»é¡Œ");
      el.classList.add("center");
      container.appendChild(el);
    }

    // B. è™•ç†ä¸»è¦ä½ç½®
    positions.forEach((posName, i) => {
      const c = deck[cardIdx++];
      // æ±ºå®šæ­£é€†ä½ (50% æ©Ÿç‡)
      c.reversed = allowReversed && (window.crypto.getRandomValues(new Uint8Array(1))[0] < 128);
      
      resultText.push(`${posName || (i+1)}:${c.name}${c.reversed?'(é€†)':''}`);

      const el = renderCard(c, posName, (div) => {
        // è³¦äºˆ grid area class
        if (spread === "five" && document.getElementById("fiveVariant").value === "choice") div.classList.add("c"+(i+1));
        if (spread === "celtic") div.classList.add("c"+(i+1));
        
        // åäºŒå¼µåœ“å½¢è¨ˆç®— CSS ä½ç½®
        if (isTwelve) {
          const angle = getTwelveAngle(document.getElementById("twelveVariant").value, i);
          const r = 300; // åŠå¾‘
          const x = 380 + r * Math.cos(degToRad(angle)); // åœ“å¿ƒ x
          const y = 380 + r * Math.sin(degToRad(angle)); // åœ“å¿ƒ y
          div.style.left = x + "px";
          div.style.top = y + "px";
        }
      });
      container.appendChild(el);
    });

    // C. å¯«å…¥æ­·å²ç´€éŒ„
    const historyLine = `ã€${getTimestamp()}ã€‘${question ? `[å•:${question}] ` : ''}${resultText.join(" / ")}`;
    const historyArea = document.getElementById("history");
    historyArea.value = historyLine + "\n" + historyArea.value;
    
    // å­˜å…¥ Cookie
    document.cookie = "tarot_history=" + encodeURIComponent(historyArea.value) + "; max-age=" + (86400*30);
  }

  // ===== 5. UI äº‹ä»¶ç¶å®š =====
  function updateUI() {
    const val = document.getElementById("spread").value;
    document.getElementById("threeVariantLabel").style.display = val === "three" ? "inline-flex" : "none";
    document.getElementById("fiveVariantLabel").style.display = val === "five" ? "inline-flex" : "none";
    document.getElementById("twelveVariantLabel").style.display = val === "twelve" ? "inline-flex" : "none";
    document.getElementById("twelveThemeLabel").style.display = val === "twelve" ? "inline-flex" : "none";
  }

  document.getElementById("spread").addEventListener("change", updateUI);
  document.getElementById("drawBtn").addEventListener("click", drawCards);
  
  // è¤‡è£½æœ€æ–°
  document.getElementById("copyLatestBtn").addEventListener("click", () => {
    const h = document.getElementById("history");
    if (!h.value) return;
    const latest = h.value.split('\n')[0];
    const temp = document.createElement("textarea");
    temp.value = latest;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand("copy");
    document.body.removeChild(temp);
    
    const btn = document.getElementById("copyLatestBtn");
    const originalText = btn.innerText;
    btn.innerText = "å·²è¤‡è£½ï¼";
    setTimeout(() => { btn.innerText = originalText; }, 1000);
  });

  document.getElementById("copyHistoryBtn").addEventListener("click", () => {
    const h = document.getElementById("history");
    h.select();
    document.execCommand("copy");
  });
  
  document.getElementById("clearHistoryBtn").addEventListener("click", () => {
    if(confirm("ç¢ºå®šæ¸…ç©ºç´€éŒ„ï¼Ÿ")) {
      document.getElementById("history").value = "";
      document.cookie = "tarot_history=; max-age=0";
    }
  });

  // è®€å–æ­·å²
  const match = document.cookie.match(/tarot_history=([^;]+)/);
  if (match) document.getElementById("history").value = decodeURIComponent(match[1]);

  updateUI();
</script>
</body>
</html>
