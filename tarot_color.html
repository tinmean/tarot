<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¡”ç¾…ç‰ŒæŠ½ç‰Œç¨‹å¼ï¼ˆè‡ªå®šç¾©åœ–æºç‰ˆï¼‰</title>
  <style>
    :root {
      --bg-color: #1a1a2e;
      --panel-bg: rgba(22, 27, 34, 0.9);
      --text-color: #e6edf3;
      --accent-color: #f1c40f;
      --card-bg: #ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    body {
      font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      color: var(--accent-color);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .controls {
      background: var(--panel-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      max-width: 900px;
      width: 100%;
      align-items: flex-end;
      margin-bottom: 30px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label { font-size: 14px; font-weight: bold; color: var(--accent-color); }

    input, select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: white;
      outline: none;
    }

    button {
      padding: 10px 24px;
      background: var(--accent-color);
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      height: 42px;
    }

    button:hover { transform: translateY(-2px); filter: brightness(1.1); }
    button:active { transform: translateY(0); }

    .result-container {
      width: 100%;
      max-width: 1200px;
      position: relative;
      margin-top: 20px;
    }

    .cards-grid {
      display: grid;
      gap: 20px;
      justify-content: center;
      min-height: 300px;
    }

    .grid-one { grid-template-columns: repeat(1, 200px); }
    .grid-three { grid-template-columns: repeat(3, 1fr); }
    .grid-five { grid-template-columns: repeat(5, 1fr); }
    
    .grid-celtic {
      display: grid;
      grid-template-columns: repeat(6, 150px);
      grid-template-rows: repeat(4, 220px);
      gap: 10px;
      justify-content: center;
    }

    .card-wrapper {
      position: relative;
      perspective: 1000px;
    }

    .card {
      width: 100%;
      aspect-ratio: 5/8.5;
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .card:hover { transform: translateY(-10px) scale(1.05); z-index: 10; }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card.reversed img {
      transform: rotate(180deg);
    }

    .card-label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      text-align: center;
      padding: 5px 0;
      font-size: 12px;
      backdrop-filter: blur(4px);
    }

    .card-pos {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-color);
      color: #1a1a2e;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      z-index: 5;
      white-space: nowrap;
    }

    .spread-circle {
      position: relative;
      width: 800px;
      height: 800px;
      margin: 0 auto;
    }
    .spread-circle .card-wrapper {
      position: absolute;
      width: 120px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      cursor: zoom-out;
    }
    .overlay.active { display: flex; }
    .overlay img {
      max-height: 85vh;
      border-radius: 15px;
      box-shadow: 0 0 50px rgba(255,255,255,0.1);
    }
    .overlay-info {
      position: absolute;
      bottom: 20px;
      text-align: center;
      color: white;
    }

    .history-section {
      width: 100%;
      max-width: 900px;
      margin-top: 50px;
      background: var(--panel-bg);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    textarea {
      width: 100%;
      background: #0d1117;
      border: 1px solid #30363d;
      color: #8b949e;
      border-radius: 8px;
      padding: 10px;
      font-family: monospace;
      resize: vertical;
    }

    .fallback-text {
      padding: 20px;
      text-align: center;
      color: #333;
      font-size: 12px;
      background: #eee;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    footer { margin: 40px 0; color: #484f58; font-size: 12px; }

    @media (max-width: 768px) {
      .spread-circle { transform: scale(0.4); margin: -200px 0; }
      .grid-three, .grid-five { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>

  <h1>ğŸ”® å¡”ç¾…è‡ªå®šç¾©æŠ½ç‰Œç³»çµ±</h1>

  <div class="controls">
    <div class="control-group" style="flex: 1; min-width: 200px;">
      <label>æ‚¨çš„æå•</label>
      <input type="text" id="question" placeholder="è¼¸å…¥å•é¡Œï¼ˆé¸å¡«ï¼‰..." />
    </div>

    <div class="control-group">
      <label>é¸æ“‡ç‰Œé™£</label>
      <select id="spreadType">
        <option value="one">å–®å¼µå åœ</option>
        <option value="three" selected>ä¸‰å¼µç‰Œé™£ (éå»/ç¾åœ¨/æœªä¾†)</option>
        <option value="five">äº”å¼µç„¡è¦–è«– (æˆ–äºŒæ“‡ä¸€)</option>
        <option value="twelve">åäºŒå®®ä½åœ“é™£</option>
        <option value="celtic">è³½çˆ¾ç‰¹åå­—</option>
      </select>
    </div>

    <div class="control-group">
      <label>è¨­å®š</label>
      <div style="display: flex; gap: 10px; align-items: center; height: 40px;">
        <label style="color:white; font-weight: normal;"><input type="checkbox" id="allowReversed" checked> é€†ä½</label>
        <label style="color:white; font-weight: normal;"><input type="checkbox" id="useMajorOnly"> åƒ…å¤§ç‰Œ</label>
      </div>
    </div>

    <button id="drawBtn">âœ¨ æŠ½ç‰Œå•Ÿå‹•</button>
  </div>

  <div class="result-container" id="resultArea"></div>

  <div class="history-section">
    <label>æ­·å²ç´€éŒ„</label>
    <textarea id="history" rows="5" readonly></textarea>
    <div style="display: flex; gap: 10px;">
      <button onclick="clearHistory()" style="background:#30363d; color:white; font-size:12px; padding:5px 10px; margin-top:5px;">æ¸…ç©ºç´€éŒ„</button>
      <button onclick="copyHistory()" style="background:#30363d; color:white; font-size:12px; padding:5px 10px; margin-top:5px;">è¤‡è£½ç´€éŒ„</button>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="this.classList.remove('active')">
    <img id="overlayImg" src="" alt="å¤§åœ–">
    <div class="overlay-info">
      <h2 id="overlayName"></h2>
      <p id="overlayDesc"></p>
    </div>
  </div>

  <footer>
    å¡”ç¾…ç‰Œå½±åƒç”±ä½¿ç”¨è€…è‡ªå®šç¾©æä¾› | åŸºæ–¼ Web Crypto API ç”Ÿæˆéš¨æ©Ÿæ•¸
  </footer>

  <script>
    // è¨­å®šåœ–ç‰‡ç›®éŒ„ç‚º HTML æ‰€åœ¨çš„ images è³‡æ–™å¤¾
    const IMAGE_BASE_URL = "./images/"; 

    const majorNames = ["æ„šè€…", "é­”è¡“å¸«", "å¥³ç¥­å¸", "çš‡å", "çš‡å¸", "æ•™çš‡", "æˆ€äºº", "æˆ°è»Š", "åŠ›é‡", "éš±è€…", "å‘½é‹ä¹‹è¼ª", "æ­£ç¾©", "å€’åŠäºº", "æ­»ç¥", "ç¯€åˆ¶", "æƒ¡é­”", "é«˜å¡”", "æ˜Ÿæ˜Ÿ", "æœˆäº®", "å¤ªé™½", "å¯©åˆ¤", "ä¸–ç•Œ"];
    const suitData = [
      { name: "æ¬Šæ–", code: "wands" },
      { name: "è–æ¯", code: "cups" },
      { name: "å¯¶åŠ", code: "swords" },
      { name: "éŒ¢å¹£", code: "pents" }
    ];

    let fullDeck = [];

    function initDeck() {
      fullDeck = [];
      // å¤§ç‰Œæ˜ å°„: maj00.jpg ~ maj21.jpg
      majorNames.forEach((name, i) => {
        fullDeck.push({
          name,
          type: "Major",
          file: `maj${String(i).padStart(2, '0')}.jpg`
        });
      });
      // å°ç‰Œæ˜ å°„: ç³»åˆ—å + 01~14.jpg (ä¾‹å¦‚ cups01.jpg)
      suitData.forEach(suit => {
        for (let i = 1; i <= 14; i++) {
          let rankName = "";
          if (i === 1) rankName = "Ace";
          else if (i <= 10) rankName = i;
          else if (i === 11) rankName = "ä¾è€…";
          else if (i === 12) rankName = "é¨å£«";
          else if (i === 13) rankName = "çš‡å";
          else if (i === 14) rankName = "åœ‹ç‹";

          fullDeck.push({
            name: `${suit.name}${rankName}`,
            type: "Minor",
            file: `${suit.code}${String(i).padStart(2, '0')}.jpg`
          });
        }
      });
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const random = window.crypto.getRandomValues(new Uint32Array(1))[0];
        const j = random % (i + 1);
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function getSpreadConfig(type) {
      switch(type) {
        case 'one': return { grid: 'grid-one', labels: ['å•Ÿç¤º'] };
        case 'three': return { grid: 'grid-three', labels: ['éå»', 'ç¾åœ¨', 'æœªä¾†'] };
        case 'five': return { grid: 'grid-five', labels: ['ç¾æ³', 'éšœç¤™', 'æ½›æ„è­˜', 'è¿‘æœªä¾†', 'æœ€çµ‚å»ºè­°'] };
        case 'twelve': return { grid: 'circle', labels: ['1å®®', '2å®®', '3å®®', '4å®®', '5å®®', '6å®®', '7å®®', '8å®®', '9å®®', '10å®®', '11å®®', '12å®®'] };
        case 'celtic': return { grid: 'celtic', labels: ['1.ç¾æ³', '2.é˜»ç¤™', '3.ç›®æ¨™', '4.åŸºç¤', '5.éå»', '6.æœªä¾†', '7.è‡ªæˆ‘', '8.ç’°å¢ƒ', '9.å¸Œæœ›', '10.çµæœ'] };
        default: return { grid: 'grid-one', labels: ['ç‰Œ'] };
      }
    }

    function createCardElement(cardData, label, isReversed) {
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';

      const posTag = document.createElement('div');
      posTag.className = 'card-pos';
      posTag.innerText = label;
      wrapper.appendChild(posTag);

      const card = document.createElement('div');
      card.className = `card ${isReversed ? 'reversed' : ''}`;
      
      const imgPath = `${IMAGE_BASE_URL}${cardData.file}`;
      const img = document.createElement('img');
      img.src = imgPath;
      img.alt = cardData.name;
      
      img.addEventListener('error', () => {
        img.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.className = 'fallback-text';
        fallback.innerHTML = `åœ–æª”ç¼ºå¤±<br>${cardData.file}`;
        card.prepend(fallback);
        card.style.background = '#333';
      });

      const labelDiv = document.createElement('div');
      labelDiv.className = 'card-label';
      labelDiv.innerText = `${cardData.name} ${isReversed ? '(é€†)' : ''}`;

      card.appendChild(img);
      card.appendChild(labelDiv);

      card.addEventListener('click', () => {
        const overlay = document.getElementById('overlay');
        const overlayImg = document.getElementById('overlayImg');
        overlayImg.src = imgPath;
        overlayImg.style.transform = isReversed ? 'rotate(180deg)' : 'none';
        document.getElementById('overlayName').innerText = `${cardData.name} ${isReversed ? '(é€†ä½)' : '(æ­£ä½)'}`;
        document.getElementById('overlayDesc').innerText = `ä½ç½®ï¼š${label}`;
        overlay.classList.add('active');
      });

      wrapper.appendChild(card);
      return wrapper;
    }

    function draw() {
      initDeck();
      const useMajorOnly = document.getElementById('useMajorOnly').checked;
      let deck = useMajorOnly ? fullDeck.filter(c => c.type === "Major") : [...fullDeck];
      
      if (deck.length === 0) {
        alert("ç‰Œçµ„ç‚ºç©ºï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚");
        return;
      }

      shuffle(deck);

      const spreadType = document.getElementById('spreadType').value;
      const config = getSpreadConfig(spreadType);
      const allowReversed = document.getElementById('allowReversed').checked;
      
      const area = document.getElementById('resultArea');
      area.innerHTML = '';
      
      const gridDiv = document.createElement('div');
      gridDiv.className = config.grid === 'circle' ? 'spread-circle' : `cards-grid ${config.grid}`;
      area.appendChild(gridDiv);

      let record = [];

      config.labels.forEach((label, i) => {
        if (i >= deck.length) return;
        
        const cardData = deck[i];
        const isReversed = allowReversed && (window.crypto.getRandomValues(new Uint8Array(1))[0] > 127);
        
        record.push(`${label}: ${cardData.name}${isReversed ? '(é€†)' : ''}`);

        const cardWrapper = createCardElement(cardData, label, isReversed);
        
        if (config.grid === 'circle') {
          const angle = (i * 30) - 90;
          const radius = 300;
          const x = 340 + radius * Math.cos(angle * Math.PI / 180);
          const y = 340 + radius * Math.sin(angle * Math.PI / 180);
          cardWrapper.style.left = `${x}px`;
          cardWrapper.style.top = `${y}px`;
        }

        gridDiv.appendChild(cardWrapper);
      });

      const question = document.getElementById('question').value;
      const time = new Date().toLocaleString();
      const historyText = `ã€${time}ã€‘ å•é¡Œï¼š${question || 'æœªè¨­å•'}\nçµæœï¼š${record.join(', ')}\n------------------------\n`;
      document.getElementById('history').value = historyText + document.getElementById('history').value;
    }

    function clearHistory() {
      if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) {
        document.getElementById('history').value = '';
      }
    }
    
    function copyHistory() {
      const history = document.getElementById('history');
      history.select();
      document.execCommand('copy');
      alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }

    document.getElementById('drawBtn').addEventListener('click', draw);
    initDeck();
  </script>
</body>
</html>
