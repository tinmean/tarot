<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ˆæ¥­å¡”ç¾…æŠ½ç‰Œç³»çµ± - éŸ¿æ‡‰å¼å¤§åœ–ç‰ˆ</title>
  <style>
    :root {
      --bg-color: #0f0c29;
      --bg-gradient: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
      --panel-bg: rgba(255, 255, 255, 0.05);
      --text-color: #e0e0e0;
      --accent-color: #f1c40f;
      /* åŠ å¤§åŸºæº–å¡ç‰‡å°ºå¯¸ */
      --card-width: 140px;
      --card-height: 238px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-color);
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1 {
      color: var(--accent-color);
      text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
      font-size: 1.8rem;
      margin: 20px 0;
      text-align: center;
    }

    /* æ§åˆ¶é¢æ¿ */
    .controls {
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      width: 100%;
      max-width: 1000px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }

    label { font-size: 14px; color: var(--accent-color); font-weight: bold; }

    input[type="text"], select {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.4);
      color: white;
      outline: none;
      font-size: 15px;
      width: 100%;
    }

    .checkbox-group {
      display: flex;
      gap: 15px;
      align-items: center;
      height: 45px;
      font-size: 15px;
    }

    button {
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      border: none;
    }

    button#drawBtn {
      width: 100%;
      padding: 16px;
      background: var(--accent-color);
      color: #1a1a2e;
      border-radius: 12px;
      font-size: 18px;
      margin-top: 10px;
      box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
    }

    button#drawBtn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 0 25px var(--accent-color);
    }

    /* æ­·å²ç´€éŒ„æŒ‰éˆ• */
    .history-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-small:hover { background: rgba(255, 255, 255, 0.2); color: white; }
    .btn-danger:hover { background: #c0392b; color: white; border-color: #c0392b; }

    /* ç‰Œé™£å±•ç¤ºå€åŸŸ */
    .spread-viewport {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 30px;
      min-height: 700px; /* åŠ é«˜ä»¥å®¹ç´å¤§åœ– */
      padding-bottom: 100px;
    }

    #spreadContainer {
      position: relative;
      transform-origin: top center;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .spread-area { position: relative; margin: 0 auto; }

    /* ç·šæ€§æ’åˆ— (å¤§å°ºå¯¸é©é…) */
    .layout-linear {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: nowrap;
    }

    .card-slot {
      position: relative;
      width: var(--card-width);
      height: var(--card-height);
    }

    .card {
      width: 100%;
      height: 100%;
      background: #111;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      cursor: pointer;
      position: relative;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .card:hover { 
      transform: translateY(-10px) scale(1.03); 
      box-shadow: 0 15px 35px rgba(241, 196, 15, 0.4); 
      z-index: 50;
    }
    .card img { width: 100%; height: 100%; object-fit: cover; }
    .card.reversed img { transform: rotate(180deg); }

    .card-label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.85);
      color: #fff;
      font-size: 11px;
      text-align: center;
      padding: 6px 0;
      backdrop-filter: blur(5px);
    }

    .pos-tag {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      color: var(--accent-color);
      white-space: nowrap;
      text-align: center;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    /* è¤‡é›œé™£å‹å¯¬é«˜ (åŸºæº–å€¼åŠ å¤§) */
    .spread-area.layout-custom { width: 800px; height: 750px; }
    .spread-area.layout-circle { width: 750px; height: 750px; }
    
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.96);
      display: none; justify-content: center; align-items: center; z-index: 2000;
      backdrop-filter: blur(10px);
    }
    .overlay.active { display: flex; }
    .overlay-content { text-align: center; max-width: 95%; }
    .overlay img { max-height: 80vh; border-radius: 15px; border: 3px solid var(--accent-color); box-shadow: 0 0 50px rgba(241, 196, 15, 0.2); }

    .history-section {
      width: 100%; max-width: 1000px; margin-top: 40px;
      background: var(--panel-bg); padding: 25px; border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    textarea { 
      width: 100%; background: #050505; color: #ccc; border: 1px solid #222; 
      padding: 15px; font-size: 14px; resize: vertical; line-height: 1.7; 
      border-radius: 10px;
    }

    .fallback { display: flex; align-items: center; justify-content: center; height: 100%; background: #222; color: #555; font-size: 12px; text-align: center; padding: 10px; }

    @media (max-width: 600px) {
      h1 { font-size: 1.4rem; }
      .controls { padding: 15px; }
    }
  </style>
</head>
<body>

  <h1>ğŸ”® å°ˆæ¥­å¡”ç¾…æŠ½ç‰Œç³»çµ±</h1>

  <div class="controls">
    <div class="control-group">
      <label>æ‚¨çš„å•é¡Œ</label>
      <input type="text" id="question" placeholder="è¼¸å…¥æƒ³å•çš„äº‹æƒ…ï¼Œè®“ç‰Œå¡æŒ‡å¼•æ‚¨..." />
    </div>

    <div class="control-group">
      <label>1. é¸æ“‡å¼µæ•¸</label>
      <select id="cardCount">
        <option value="1">1 å¼µç‰Œ</option>
        <option value="3">3 å¼µç‰Œ</option>
        <option value="5" selected>5 å¼µç‰Œ</option>
        <option value="7">7 å¼µç‰Œ</option>
        <option value="10">10 å¼µç‰Œ</option>
        <option value="12">12 å¼µç‰Œ</option>
      </select>
    </div>

    <div class="control-group">
      <label>2. é¸æ“‡ç‰Œé™£</label>
      <select id="spreadVariant">
        <!-- æœƒç”± JS å‹•æ…‹ç”Ÿæˆ -->
      </select>
    </div>

    <div class="control-group">
      <label>åŠŸèƒ½è¨­å®š</label>
      <div class="checkbox-group">
        <label><input type="checkbox" id="incMajor" checked> å¤§ç‰Œ</label>
        <label><input type="checkbox" id="incMinor" checked> å°ç‰Œ</label>
        <label><input type="checkbox" id="allowRev" checked> é€†ä½</label>
      </div>
    </div>

    <button id="drawBtn">âœ¨ é–‹å§‹æ´—ç‰ŒæŠ½ç‰Œ</button>
  </div>

  <div class="spread-viewport">
    <div id="spreadContainer"></div>
  </div>

  <div class="history-section">
    <label>æ­·å²å åœç´€éŒ„</label>
    <div class="history-controls">
      <button onclick="copyLatestHistory(this)" class="btn-small">è¤‡è£½æœ€æ–°</button>
      <button onclick="copyAllHistory(this)" class="btn-small">è¤‡è£½å…¨éƒ¨</button>
      <button onclick="clearHistory()" class="btn-small btn-danger">æ¸…é™¤ç´€éŒ„</button>
    </div>
    <textarea id="history" rows="8" readonly></textarea>
  </div>

  <div class="overlay" id="overlay" onclick="this.classList.remove('active')">
    <div class="overlay-content">
      <img id="overlayImg" src="">
      <h3 id="overlayTitle" style="color:var(--accent-color); margin: 20px 0 5px 0; font-size: 24px;"></h3>
      <p id="overlayPos" style="font-size:16px; margin: 0; color: #aaa;"></p>
    </div>
  </div>

  <script>
    const IMAGE_BASE_URL = "./images/";

    const MAJOR_NAMES = ["æ„šè€…", "é­”è¡“å¸«", "å¥³ç¥­å¸", "çš‡å", "çš‡å¸", "æ•™çš‡", "æˆ€äºº", "æˆ°è»Š", "åŠ›é‡", "éš±è€…", "å‘½é‹ä¹‹è¼ª", "æ­£ç¾©", "å€’åŠäºº", "æ­»ç¥", "ç¯€åˆ¶", "æƒ¡é­”", "é«˜å¡”", "æ˜Ÿæ˜Ÿ", "æœˆäº®", "å¤ªé™½", "å¯©åˆ¤", "ä¸–ç•Œ"];
    const SUITS = [
      { name: "æ¬Šæ–", code: "wands" },
      { name: "è–æ¯", code: "cups" },
      { name: "å¯¶åŠ", code: "swords" },
      { name: "éŒ¢å¹£", code: "pents" }
    ];

    // ç‰Œé™£åº§æ¨™éš¨å¤§å¡ç‰‡å°ºå¯¸èª¿æ•´ (ä»¥ 140px ç‚ºåŸºæº–)
    const SPREAD_CONFIG = {
      "1": { "one": { type: 'linear', labels: ['å•Ÿç¤º'] } },
      "3": {
        "ppf": { type: 'linear', labels: ['éå»', 'ç¾åœ¨', 'æœªä¾†'] },
        "spa": { type: 'linear', labels: ['ç¾æ³', 'å•é¡Œ', 'å»ºè­°'] },
        "bms": { type: 'linear', labels: ['èº«', 'å¿ƒ', 'éˆ'] }
      },
      "5": {
        "neglect": { type: 'linear', labels: ['1', '2', '3', '4', '5'], hideTags: true },
        "choice": { type: 'linear', labels: ['é¸é …A', 'è¶¨å‹¢A', 'é¸é …B', 'è¶¨å‹¢B', 'å»ºè­°'] },
        "relation": { type: 'linear', labels: ['æœ¬äººç‹€æ…‹âŠ', 'æˆ‘æ–¹æ…‹åº¦â‹', 'å°æ–¹ç‹€æ…‹âŒ', 'å°æ–¹æ…‹åº¦â', 'å¯èƒ½çµæœâ'] }
      },
      "7": { "weekly": { type: 'linear', labels: ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'] } },
      "10": {
        "celtic": { 
          type: 'custom', 
          labels: ['1.ç¾æ³', '2.é˜»ç¤™', '3.åŸºç¤', '4.éå»', '5.ç›®æ¨™', '6.æœªä¾†', '7.è‡ªæˆ‘', '8.ç’°å¢ƒ', '9.å¸Œæœ›', '10.çµæœ'],
          coords: [
            { x: 200, y: 220 }, { x: 200, y: 220, rotate: 90, z: 10 }, { x: 200, y: 485 }, 
            { x: 10, y: 220 }, { x: 200, y: -45 }, { x: 390, y: 220 }, 
            { x: 620, y: 485 }, { x: 620, y: 310 }, { x: 620, y: 135 }, { x: 620, y: -40 }
          ]
        }
      },
      "12": {
        "houses": { type: 'circle', labels: ['1.å‘½å®®/è‡ªæˆ‘', '2.è²¡å¸›/è²¡é‹', '3.å…„å¼Ÿ/æºé€š', '4.ç”°å®…/å®¶åº­', '5.å­å¥³/æˆ€æ„›', '6.å¥´åƒ•/å¥åº·', '7.å¤«å¦»/ä¼´ä¾¶', '8.ç–¾å„/è½‰åŒ–', '9.é·ç§»/é«˜ç­‰', '10.å®˜ç¥¿/äº‹æ¥­', '11.ç¦å¾·/ç¤¾äº¤', '12.ç›¸è²Œ/æ½›æ„è­˜'] },
        "months": { type: 'circle', labels: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'] }
      }
    };

    const SPREAD_NAMES = {
      "one": "å–®å¼µå åœ", "ppf": "éå»/ç¾åœ¨/æœªä¾†", "spa": "ç¾æ³/å•é¡Œ/å»ºè­°", "bms": "èº«/å¿ƒ/éˆ",
      "neglect": "äº”å¼µç„¡è¦–è«–", "choice": "äºŒæ“‡ä¸€ç‰Œé™£", "relation": "æ„Ÿæƒ…é—œä¿‚ç‹€æ…‹é™£",
      "weekly": "é€±é‹å‹¢ (ä¸ƒå¤©)", "celtic": "è³½çˆ¾ç‰¹åå­— (10å¼µå¤§é™£)", "houses": "åäºŒå®®ä½ (é€†æ™‚é‡)", "months": "åäºŒå€‹æœˆé‹å‹¢"
    };

    function updateSpreadVariants() {
      const count = document.getElementById('cardCount').value;
      const variantSelect = document.getElementById('spreadVariant');
      variantSelect.innerHTML = '';
      const options = SPREAD_CONFIG[count];
      for (let key in options) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.innerText = SPREAD_NAMES[key] || key;
        variantSelect.appendChild(opt);
      }
    }

    function getDeck(incMajor, incMinor) {
      let deck = [];
      if (incMajor) MAJOR_NAMES.forEach((name, i) => deck.push({ name, file: `maj${String(i).padStart(2, '0')}.jpg` }));
      if (incMinor) {
        SUITS.forEach(suit => {
          for (let i = 1; i <= 14; i++) {
            let n = i === 1 ? "Ace" : (i === 11 ? "ä¾è€…" : (i === 12 ? "é¨å£«" : (i === 13 ? "çš‡å" : (i === 14 ? "åœ‹ç‹" : i))));
            deck.push({ name: `${suit.name}${n}`, file: `${suit.code}${String(i).padStart(2, '0')}.jpg` });
          }
        });
      }
      return deck;
    }

    function copyToClipboard(text, btn) {
      const el = document.createElement('textarea');
      el.value = text;
      el.setAttribute('readonly', '');
      el.style.position = 'absolute';
      el.style.left = '-9999px';
      document.body.appendChild(el);
      el.select();
      try {
        const successful = document.execCommand('copy');
        if (successful && btn) {
          const originalText = btn.innerText;
          btn.innerText = "å·²è¤‡è£½ï¼";
          setTimeout(() => { btn.innerText = originalText; }, 1500);
        }
      } catch (err) {}
      document.body.removeChild(el);
    }

    function copyAllHistory(btn) {
      const historyText = document.getElementById('history').value;
      if (!historyText) return;
      copyToClipboard(historyText.trim(), btn);
    }

    function copyLatestHistory(btn) {
      const historyText = document.getElementById('history').value;
      if (!historyText) return;
      const entries = historyText.split(/\n\s*\n+/);
      const latest = entries.find(e => e.trim().length > 0);
      if (latest) copyToClipboard(latest.trim(), btn);
    }

    function clearHistory() {
      if (document.getElementById('history').value === "") return;
      if (window.confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å åœç´€éŒ„å—ï¼Ÿ")) {
        document.getElementById('history').value = "";
      }
    }

    function draw() {
      const incMajor = document.getElementById('incMajor').checked;
      const incMinor = document.getElementById('incMinor').checked;
      const allowRev = document.getElementById('allowRev').checked;
      const count = document.getElementById('cardCount').value;
      const variantKey = document.getElementById('spreadVariant').value;
      
      if (!variantKey) return;
      const config = SPREAD_CONFIG[count][variantKey];
      let deck = getDeck(incMajor, incMinor);
      if (deck.length < config.labels.length) {
        alert("ç‰Œæ•¸ä¸è¶³ï¼Œè«‹æª¢æŸ¥å¤§ç‰Œ/å°ç‰Œå‹¾é¸è¨­å®šï¼");
        return;
      }

      for (let i = deck.length - 1; i > 0; i--) {
        const j = window.crypto.getRandomValues(new Uint32Array(1))[0] % (i + 1);
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }

      const container = document.getElementById('spreadContainer');
      container.innerHTML = '';
      const spreadArea = document.createElement('div');
      spreadArea.className = `spread-area layout-${config.type}`;

      let results = [];
      config.labels.forEach((label, i) => {
        const cardData = deck[i];
        const isRev = allowRev && (window.crypto.getRandomValues(new Uint8Array(1))[0] > 127);
        results.push(`${label}:${cardData.name}${isRev?'(é€†)':''}`);

        const slot = document.createElement('div');
        slot.className = 'card-slot';
        
        if (config.type === 'custom') {
          const c = config.coords[i];
          slot.style.position = 'absolute';
          slot.style.left = c.x + 'px';
          slot.style.top = c.y + 'px';
          if (c.z) slot.style.zIndex = c.z;
        } else if (config.type === 'circle') {
          // åäºŒå®®ä½é€†æ™‚é‡é †åº
          const angle = 180 - (i * 30);
          const r = 260; // åœ“é™£åŠå¾‘åŠ å¤§
          const centerX = 300, centerY = 260;
          slot.style.position = 'absolute';
          slot.style.left = (centerX + r * Math.cos(angle * Math.PI / 180)) + 'px';
          slot.style.top = (centerY + r * Math.sin(angle * Math.PI / 180)) + 'px';
        }

        const card = document.createElement('div');
        card.className = `card ${isRev ? 'reversed' : ''}`;
        if (config.type === 'custom' && config.coords[i].rotate) {
            card.style.transform = `rotate(${config.coords[i].rotate}deg)`;
        }

        const img = document.createElement('img');
        img.src = `${IMAGE_BASE_URL}${cardData.file}`;
        img.onerror = () => {
          img.style.display = 'none';
          const fb = document.createElement('div');
          fb.className = 'fallback';
          fb.innerHTML = `ç¼ºå°‘åœ–æª”<br>${cardData.file}`;
          card.appendChild(fb);
        };

        const lbl = document.createElement('div');
        lbl.className = 'card-label';
        lbl.innerText = cardData.name;

        const tag = document.createElement('div');
        tag.className = 'pos-tag';
        tag.innerText = config.hideTags ? "" : label;

        card.appendChild(img);
        card.appendChild(lbl);
        slot.appendChild(tag);
        slot.appendChild(card);
        spreadArea.appendChild(slot);

        card.onclick = () => {
          const overlayImg = document.getElementById('overlayImg');
          overlayImg.src = img.src;
          overlayImg.className = isRev ? 'reversed' : '';
          document.getElementById('overlayTitle').innerText = cardData.name + (isRev ? ' (é€†ä½)' : ' (æ­£ä½)');
          document.getElementById('overlayPos').innerText = `ç‰Œé™£ä½ç½®ï¼š${label}`;
          document.getElementById('overlay').classList.add('active');
        };
      });

      container.appendChild(spreadArea);
      autoScale();

      const q = document.getElementById('question').value || "æœªè¨­å•";
      const log = `ã€${new Date().toLocaleString()}ã€‘ ${q}\nç‰Œé™£ï¼š${SPREAD_NAMES[variantKey]}\nçµæœï¼š${results.join(' / ')}\n\n`;
      document.getElementById('history').value = log + document.getElementById('history').value;
    }

    function autoScale() {
      const container = document.getElementById('spreadContainer');
      const viewport = document.querySelector('.spread-viewport');
      const spreadArea = container.querySelector('.spread-area');
      if (!spreadArea) return;

      // å–å¾—ç›®å‰çš„ CSS è®Šæ•¸åŸºæº–
      const cardW = 140;
      const gap = 20;

      let baseWidth = 800; // é è¨­è¤‡é›œé™£å‹å¯¬åº¦
      if (spreadArea.classList.contains('layout-linear')) {
          const count = spreadArea.children.length;
          baseWidth = (cardW * count) + (gap * (count - 1));
      } else if (spreadArea.classList.contains('layout-custom')) {
          baseWidth = 800;
      } else if (spreadArea.classList.contains('layout-circle')) {
          baseWidth = 750;
      }

      const availableWidth = viewport.offsetWidth - 20;

      // å¦‚æœè¢å¹•ä¸å¤ å¯¬ï¼Œå‰‡ç¸®å°ï¼›å¦‚æœå¤ å¯¬ï¼Œå‰‡ç¶­æŒ 1:1 (å¤§åœ–)
      if (availableWidth < baseWidth) {
        const scale = availableWidth / baseWidth;
        container.style.transform = `scale(${scale})`;
        viewport.style.height = (spreadArea.offsetHeight * scale + 100) + "px";
      } else {
        container.style.transform = 'scale(1)';
        viewport.style.height = "auto";
      }
    }

    window.addEventListener('resize', autoScale);
    document.getElementById('cardCount').addEventListener('change', updateSpreadVariants);
    document.getElementById('drawBtn').onclick = draw;
    window.onload = () => { updateSpreadVariants(); };
  </script>
</body>
</html>
